<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ACE FLOW - Agentes de Combate √†s Endemias</title>
    
    <!-- PWA (Progressive Web App) Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ACE FLOW">
    <link rel="apple-touch-icon" href="https://i.imgur.com/ArDb28v.png">
    <meta name="theme-color" content="#F5F0E6">

    <!-- Depend√™ncias -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- PWA MANIFEST ---
            const manifest = {
                "id": "/",
                "name": "ACE FLOW",
                "short_name": "ACE FLOW",
                "scope": ".",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#F5F0E6",
                "theme_color": "#4338CA",
                "description": "App para registro de trabalho de Agentes de Combate √†s Endemias.",
                "icons": [
                    { "src": "https://i.imgur.com/ArDb28v.png", "sizes": "192x192", "type": "image/png", "purpose": "any maskable" },
                    { "src": "https://i.imgur.com/ArDb28v.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
                ]
            };
            const manifestString = JSON.stringify(manifest);
            const blob = new Blob([manifestString], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            const linkTag = document.createElement('link');
            linkTag.rel = 'manifest';
            linkTag.href = manifestURL;
            document.head.appendChild(linkTag);

            // --- SERVICE WORKER ---
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'ace-flow-cache-v74'; // Cache version bumped
                    const PRECACHE_ASSETS = [
                        '.',
                        'https://cdn.tailwindcss.com',
                        'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js',
                        'https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                        'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap',
                        'https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2',
                        'https://i.imgur.com/ArDb28v.png'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then(cache => {
                                console.log('[Service Worker] Pr√©-cacheando recursos essenciais.');
                                return cache.addAll(PRECACHE_ASSETS);
                            }).catch(error => {
                                console.error('[Service Worker] Falha no pr√©-cache:', error);
                            })
                        );
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', event => {
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.filter(name => name !== CACHE_NAME).map(name => caches.delete(name))
                                );
                            }).then(() => self.clients.claim())
                        );
                    });

                    self.addEventListener('fetch', event => {
                        if (event.request.method !== 'GET' || event.request.url.startsWith('chrome-extension://')) {
                            return;
                        }

                        // Estrat√©gia: Cache First, depois Network
                        event.respondWith(
                            caches.match(event.request).then(cachedResponse => {
                                if (cachedResponse) {
                                    return cachedResponse;
                                }

                                return fetch(event.request).then(networkResponse => {
                                    if (networkResponse && networkResponse.status === 200) {
                                        const responseToCache = networkResponse.clone();
                                        caches.open(CACHE_NAME).then(cache => {
                                            cache.put(event.request, responseToCache);
                                        });
                                    }
                                    return networkResponse;
                                });
                            })
                        );
                    });
                `;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register(swUrl)
                        .then(reg => console.log('ServiceWorker registrado com sucesso.', reg.scope))
                        .catch(err => console.log('Falha ao registrar ServiceWorker:', err));
                });
            }
        });
    </script>
    
    <!-- Estilos -->
    <style>
        :root {
            --bg-main: #F5F0E6; --bg-card: #FFFFFF; --text-dark: #000000;
            --text-muted: #575757; --border-color: #DED6C7; --alert-red: #DC2626;
            --confirm-green: #16A34A; --khaki-base: #C3B091; --khaki-dark: #a9997c;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-dark); }
        .card { background-color: var(--bg-card); border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid var(--border-color); }
        .section-title { font-weight: 700; font-size: 1.25rem; color: var(--text-dark); }
        .form-input, .form-select {
            width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 2px solid var(--border-color);
            background-color: var(--bg-card); transition: all 0.2s ease;
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--khaki-base); box-shadow: 0 0 0 3px rgba(195, 176, 145, 0.4);
        }
        .form-input.is-filled, .form-select.is-filled { border-color: var(--confirm-green); }
        .btn {
            padding: 0.8rem 1.25rem; border-radius: 0.5rem; font-weight: 700; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer; border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.7; }
        .hidden-content { display: none; overflow: hidden; transition: max-height 0.5s ease-in-out; max-height: 0; }
        .hidden-content.show { display: block; max-height: 1500px; }
        .toggle-check {
            width: 100%; height: 46px; font-weight: 700; font-size: 1.1rem; cursor: pointer;
            border: 2px solid var(--border-color); border-radius: 0.5rem; background-color: var(--bg-card);
            transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .toggle-check.tratado.is-checked { background-color: #dcfce7; color: var(--confirm-green); border-color: var(--confirm-green); }
        .toggle-check.foco.is-checked { background-color: #fee2e2; color: var(--alert-red); border-color: var(--alert-red); }
        #fixed-info-bar {
            position: sticky; top: 0; z-index: 40; transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .modal { 
            background-color: rgba(0, 0, 0, 0.7); 
            display: flex; 
            align-items: flex-start; 
            justify-content: center;
            padding-top: 5vh;
            padding-bottom: 5vh;
            overflow-y: auto;
        }
        option.important-value { font-weight: 700; background-color: #eeeeee; }
        
        /* Landing Page Remodel */
        #landingPage { 
            background: radial-gradient(circle, rgba(245,240,230,1) 0%, rgba(222,214,199,1) 100%);
            animation: fadeIn 1.5s ease-in-out; 
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .glow-text {
            background: linear-gradient(90deg, var(--khaki-dark), var(--text-dark), var(--khaki-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: glow 10s linear infinite;
            background-size: 200% auto;
        }
        @keyframes glow { to { background-position: 200% center; } }
        .feature-card {
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 30px rgba(0,0,0,0.15);
        }
        .fade-in-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .fade-in-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--khaki-base);
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* FAQ/Curiosities Styles */
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1.5rem;
        }
        .faq-answer.show {
            max-height: 1000px; /* Adjust as needed */
            padding: 1rem 1.5rem 1.5rem;
        }
        .faq-question.active .faq-toggle-icon {
            transform: rotate(45deg);
        }

        /* Shine/Pulse Animation for CTA */
        .btn-shine {
            position: relative;
            overflow: hidden;
        }
        .btn-shine::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(45deg);
            animation: pulse-shine 4s infinite linear;
        }
        @keyframes pulse-shine {
            0% { transform: scale(0.5) rotate(45deg); opacity: 0; }
            50% { transform: scale(1) rotate(45deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(45deg); opacity: 0; }
        }

        /* Report Card Styles */
        .report-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
            animation: card-fade-in 0.5s ease-out forwards;
        }
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .report-card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280; /* text-gray-500 */
            margin-bottom: 0.5rem;
        }
        .report-card-value {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 800; /* font-extrabold */
            color: #1f2937; /* text-gray-800 */
            line-height: 1;
        }
        .report-card-unit {
            font-size: 1rem;
            font-weight: 600;
            color: #4b5563; /* text-gray-600 */
            margin-left: 0.25rem;
        }
        @keyframes card-fade-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* "Minha Area" Navigation Styles */
        .sector-view {
            animation: view-enter 0.4s ease-out;
        }
        @keyframes view-enter {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .sector-back-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
        }

    </style>
</head>

<body class="antialiased">

    <!-- LANDING PAGE REMODELADA -->
    <div id="landingPage">
        <div class="container mx-auto px-4 py-16 md:py-24 text-center">
            <header class="mb-20">
                <h1 class="text-6xl md:text-8xl font-black tracking-tighter mb-4 glow-text">ACE FLOW</h1>
                <p class="max-w-3xl mx-auto text-xl md:text-2xl font-semibold text-text-muted">
                    Sua rotina de campo, reinventada. Foco no que importa, com a tecnologia como sua aliada.
                </p>
            </header>

            <div class="space-y-24">
                <section class="fade-in-section">
                    <h2 class="text-4xl font-extrabold mb-12">Intelig√™ncia de Dados para A√ß√µes Precisas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="feature-card p-8">
                            <div class="text-5xl mb-4">üìä</div>
                            <h3 class="text-xl font-bold mb-2">Relat√≥rios Completos</h3>
                            <p class="text-text-muted">Transforme seus dados em insights visuais. Gere relat√≥rios din√¢micos e analise sua produtividade atrav√©s de filtros de tempo flex√≠veis, do trabalho di√°rio ao desempenho anual.</p>
                        </div>
                        <div class="feature-card p-8">
                            <div class="text-5xl mb-4">‚ú®</div>
                            <h3 class="text-xl font-bold mb-2">An√°lise com IA</h3>
                            <p class="text-text-muted">Receba resumos e planos de a√ß√£o gerados por Intelig√™ncia Artificial para otimizar suas visitas e focar em √°reas de risco.</p>
                        </div>
                        <div class="feature-card p-8">
                            <div class="text-5xl mb-4">üìã</div>
                            <h3 class="text-xl font-bold mb-2">PDFs Profissionais</h3>
                            <p class="text-text-muted">Exporte seus dados em PDFs autoexplicativos e resumidos. Um formato profissional, pronto para arquivamento ou compartilhamento.</p>
                        </div>
                    </div>
                </section>

                <section class="fade-in-section">
                     <h2 class="text-4xl font-extrabold mb-12">Ferramentas que Agilizam seu Dia a Dia</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="feature-card p-8">
                            <div class="text-5xl mb-4">‚úçÔ∏è</div>
                            <h3 class="text-xl font-bold mb-2">Preenchimento Inteligente</h3>
                            <p class="text-text-muted">Deixe o app trabalhar por voc√™. Nossa tecnologia antecipa seus pr√≥ximos passos, replicando informa√ß√µes e garantindo registros r√°pidos e consistentes.</p>
                        </div>
                         <div class="feature-card p-8">
                            <div class="text-5xl mb-4">üíæ</div>
                            <h3 class="text-xl font-bold mb-2">Salvamento Autom√°tico</h3>
                            <p class="text-text-muted">Seu progresso √© salvo automaticamente no hist√≥rico ao finalizar cada im√≥vel, garantindo que nenhum dado seja perdido e alimentando seus relat√≥rios em tempo real.</p>
                        </div>
                        <div class="feature-card p-8">
                           <div class="text-5xl mb-4">üì±</div>
                            <h3 class="text-xl font-bold mb-2">Experi√™ncia de App Real</h3>
                            <p class="text-text-muted">Instale no seu celular para uma experi√™ncia em tela cheia, sem a barra do navegador, com funcionamento 100% offline e sem perda de dados.</p>
                        </div>
                    </div>
                </section>

                <section class="fade-in-section">
                    <h2 class="text-4xl font-extrabold mb-12">Sua √Årea, Suas Regras</h2>
                    <div class="grid grid-cols-1">
                         <div class="feature-card p-8 max-w-2xl mx-auto">
                            <div class="text-5xl mb-4">üó∫Ô∏è</div>
                            <h3 class="text-xl font-bold mb-2">Gest√£o Personalizada</h3>
                            <p class="text-text-muted">Mapeie e gerencie sua √°rea de trabalho com total flexibilidade. Cadastre novos im√≥veis e mantenha um banco de dados pessoal e atualizado, garantindo que nenhum endere√ßo seja esquecido.</p>
                        </div>
                    </div>
                </section>

                <section class="fade-in-section">
                     <h2 class="text-4xl font-extrabold mb-12">Educa√ß√£o e Conhecimento na Palma da M√£o</h2>
                    <div class="grid grid-cols-1">
                         <div class="feature-card p-8 max-w-2xl mx-auto">
                            <div class="text-5xl mb-4">üí°</div>
                            <h3 class="text-xl font-bold mb-2">Guia de Curiosidades</h3>
                            <p class="text-text-muted">Domine o conhecimento. Acesse um guia completo que vai de d√∫vidas b√°sicas a curiosidades avan√ßadas sobre a Dengue e o Aedes. Uma ferramenta poderosa para sua capacita√ß√£o e para orientar a popula√ß√£o.</p>
                        </div>
                    </div>
                </section>
            </div>

            <footer class="mt-24 py-12 fade-in-section">
                <h2 class="text-4xl font-extrabold mb-4">Pronto para Elevar seu N√≠vel?</h2>
                <div class="flex flex-col md:flex-row justify-center items-center gap-4 mt-8">
                    <button id="startWebButton" class="btn btn-shine bg-indigo-700 text-white hover:bg-indigo-800 w-full md:w-auto text-xl py-4 px-8 shadow-lg transform hover:scale-105">Vamos l√°? Clique aqui agora</button>
                    <button id="installAppButton" class="btn bg-black text-white hover:bg-gray-800 w-full md:w-auto text-lg hidden">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Instalar no Aparelho (Offline)
                    </button>
                </div>
                 <p id="install-instructions" class="text-sm text-text-muted mt-4 max-w-2xl mx-auto hidden">
                    Ao clicar em "Instalar", o app ser√° adicionado √† sua tela inicial, como um aplicativo normal, para acesso r√°pido e funcionamento offline.
                </p>
            </footer>
        </div>
    </div>
    
    <!-- BARRA DE INFORMA√á√ÉO FIXA -->
    <div id="fixed-info-bar" class="bg-white/80 backdrop-blur-sm p-2 text-center text-sm font-semibold hidden">
        <span id="fixed-agent-name"></span> - <span id="fixed-property-info"></span>
    </div>
    
    <!-- MODAL DE LOGIN -->
    <div id="loginModal" class="fixed inset-0 z-50 modal hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 max-w-sm card">
            <h2 class="text-2xl font-bold text-center mb-1">Bem-vindo ao</h2>
            <h1 class="text-4xl font-extrabold text-center mb-6">ACE FLOW</h1>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-text-muted mb-1">Usu√°rio</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-text-muted mb-1">Senha</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" id="loginBtn" class="btn bg-blue-800 text-white hover:bg-blue-900 w-full text-lg transform hover:scale-105">Entrar</button>
                <p id="loginError" class="text-red-600 text-center mt-4 h-4"></p>
            </form>
        </div>
    </div>

    <!-- CONTE√öDO PRINCIPAL DO APP -->
    <main class="container mx-auto p-3 md:p-6 max-w-4xl hidden">
        <header class="text-center mb-8 py-4">
            <h1 class="text-5xl font-extrabold"><strong>ACE FLOW</strong></h1>
            <p class="text-lg font-bold">Agentes de Combate √†s Endemias</p>
            <p class="text-md"><em>Registre aqui a excel√™ncia do seu trabalho.</em></p>
        </header>
        
        <section class="card p-4 md:p-6 mb-6">
            <details id="goalModule" class="group">
                <summary class="section-title cursor-pointer flex justify-between items-center">
                    <div>
                        Meta Di√°ria de Im√≥veis
                        <span class="text-sm font-normal italic text-text-muted">(calcule a quantidade ideal de im√≥veis por dia)</span>
                    </div>
                    <span class="text-2xl font-bold text-khaki-base transition-transform duration-300 group-open:rotate-45">+</span>
                </summary>
                <div class="mt-4 border-t pt-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="totalImoveis" class="text-sm font-medium text-text-muted">Total de Im√≥veis</label>
                            <input type="number" min="0" oninput="this.value=this.value.replace(/[^0-9]/g,'');" id="totalImoveis" class="form-input mt-1" placeholder="Ex: 800">
                        </div>
                        <div>
                            <label for="cicloInicio" class="text-sm font-medium text-text-muted">In√≠cio do Ciclo</label>
                            <input type="date" id="cicloInicio" class="form-input mt-1">
                        </div>
                        <div>
                            <label for="cicloFim" class="text-sm font-medium text-text-muted">Fim do Ciclo</label>
                            <input type="date" id="cicloFim" class="form-input mt-1">
                        </div>
                    </div>
                    <button id="calculateGoalBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white w-full">Calcular Meta</button>
                    <div id="goalResult" class="mt-4 text-center hidden">
                        <p class="text-lg">Meta di√°ria: <strong id="dailyGoal" class="text-xl">0</strong> im√≥veis</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 mt-2 border border-border-color">
                            <div id="dailyProgress" class="bg-confirm-green h-full rounded-full text-xs font-medium text-blue-100 text-center p-0.5 leading-none" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-sm text-text-muted mt-1">0/0</p>
                    </div>
                </div>
            </details>
        </section>
        
        <section class="card p-4 md:p-6 mb-6">
            <details id="volumeCalculatorModule" class="group">
                <summary class="section-title cursor-pointer flex justify-between items-center">
                    Calcule aqui o volume do reservat√≥rio em litros
                    <span class="text-2xl font-bold text-khaki-base transition-transform duration-300 group-open:rotate-45">+</span>
                </summary>
                <div class="mt-4 border-t pt-4 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-y-4 gap-x-2">
                        <div class="space-y-1">
                            <label for="largura" class="text-sm font-medium text-text-muted">Largura</label>
                            <div class="flex gap-2">
                                <input type="number" min="0" id="largura" class="form-input" placeholder="0.0">
                                <select id="larguraUnidade" class="form-select w-auto">
                                    <option value="m">m</option>
                                    <option value="cm">cm</option>
                                </select>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label for="comprimento" class="text-sm font-medium text-text-muted">Comprimento</label>
                            <div class="flex gap-2">
                                <input type="number" min="0" id="comprimento" class="form-input" placeholder="0.0">
                                <select id="comprimentoUnidade" class="form-select w-auto">
                                    <option value="m">m</option>
                                    <option value="cm">cm</option>
                                </select>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label for="altura" class="text-sm font-medium text-text-muted">Altura/Prof.</label>
                            <div class="flex gap-2">
                                <input type="number" min="0" id="altura" class="form-input" placeholder="0.0">
                                <select id="alturaUnidade" class="form-select w-auto">
                                    <option value="m">m</option>
                                    <option value="cm">cm</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button id="calculateVolumeBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white w-full mt-4">Calcular</button>
                    <div id="volumeResult" class="mt-4 text-center hidden">
                        <div class="flex flex-col md:flex-row justify-around items-center p-4 bg-gray-50 rounded-lg space-y-4 md:space-y-0">
                            <div class="relative w-24 h-32 bg-gray-200 border-2 border-gray-400 rounded-lg overflow-hidden">
                                <div id="waterLevel" class="absolute bottom-0 w-full bg-blue-400" style="height: 0%; transition: height 1s ease-out;"></div>
                                <div id="volumeText" class="absolute inset-0 flex items-center justify-center text-black font-bold text-lg p-1"></div>
                            </div>
                            <div class="text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-500" viewBox="0 0 24 24" fill="currentColor"><path d="M20,6a8,8,0,0,0-7.3,8H3.34a1,1,0,0,0-.95,1.3l2,6A1,1,0,0,0,5.33,22h12a1,1,0,0,0,.95-.7l2-6A1,1,0,0,0,20.67,14h-3A8,8,0,0,0,20,6Z"/></svg>
                                <p id="spoonAmountText" class="font-bold text-lg"></p>
                            </div>
                            <div class="text-center">
                                <p class="text-4xl font-black" id="gramsAmountText"></p>
                                <p class="font-bold text-lg">gramas</p>
                            </div>
                        </div>
                        <button id="clearVolumeBtn" class="btn bg-red-700 hover:bg-red-800 text-white mt-4 text-sm">Limpar</button>
                    </div>
                </div>
            </details>
        </section>
        
        <section class="card p-4 md:p-6 mb-6">
            <details id="backupModule" class="group">
                <summary class="section-title cursor-pointer flex justify-between items-center">
                    Backup & Restaura√ß√£o
                    <span class="text-2xl font-bold text-khaki-base transition-transform duration-300 group-open:rotate-45">+</span>
                </summary>
                <div class="mt-4 border-t pt-4 flex flex-col md:flex-row gap-4">
                    <button id="backupBtn" class="btn bg-blue-700 hover:bg-blue-800 text-white flex-1">Fa√ßa Backup (para n√£o perder seu hist√≥rico)</button>
                    <label for="restoreInput" class="btn bg-green-700 hover:bg-green-800 text-white flex-1">
                        Restaurar Backup
                    </label>
                    <input type="file" id="restoreInput" class="hidden" accept=".json">
                </div>
            </details>
        </section>

        <section class="card p-4 md:p-6 mb-6">
            <h2 class="section-title border-b border-border-color pb-3 mb-4">Informa√ß√µes do Dia</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="agente" class="text-sm font-medium text-text-muted">Agente</label>
                    <input type="text" id="agente" list="agent-suggestions" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="bairro" class="text-sm font-medium text-text-muted">Bairro Principal</label>
                    <input type="text" id="bairro" list="bairro-suggestions" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="ciclo" class="text-sm font-medium text-text-muted">Ciclo</label>
                    <select id="ciclo" class="form-select mt-1" required></select>
                </div>
                <div>
                    <label for="data" class="text-sm font-medium text-text-muted">Data</label>
                    <input type="date" id="data" class="form-input mt-1">
                </div>
            </div>
        </section>

        <section class="space-y-4">
            <h2 class="section-title text-center mt-8 mb-4">Registros de Visita</h2>
            <div id="visitasContainer" class="space-y-3"></div>
            <button id="addVisitaBtn" class="btn bg-black text-white hover:bg-gray-800 w-full text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Adicionar Im√≥vel
            </button>
        </section>
        
        <section class="card p-4 md:p-6 my-8">
            <h2 class="section-title border-b border-border-color pb-3 mb-4">Resumo Geral</h2>
            <div id="summarySection" class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-5"></div>
        </section>

        <footer class="my-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <button id="savePdfBtn" class="btn bg-green-800 hover:bg-green-900 text-white">Gerar PDF</button>
                <button id="reportBtn" class="btn bg-purple-900 hover:bg-purple-950 text-white">Gerar Relat√≥rio</button>
                <button id="myAreaBtn" class="btn bg-amber-800 hover:bg-amber-900 text-white">Minha √Årea</button>
                <button id="clearDayBtn" class="btn bg-red-700 hover:bg-red-800 text-white">Limpar Dia</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <button id="aiCombinedAnalysisBtn" class="btn bg-blue-800 hover:bg-blue-900 text-white text-lg">An√°lise e Plano Estrat√©gico ‚ú®</button>
                 <button id="curiositiesBtn" class="btn bg-teal-600 text-white hover:bg-teal-700 text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    15 Curiosidades...
                </button>
            </div>
             <div id="subButtonsContainer" class="hidden mt-4 space-y-3 md:col-span-2">
                 <p class="text-center text-text-muted max-w-2xl mx-auto">A informa√ß√£o correta √© a nossa arma mais poderosa contra a dengue. Com o aumento dos casos, √© vital que todos conhe√ßam os detalhes sobre a doen√ßa, o mosquito transmissor e o papel crucial dos profissionais que est√£o na linha de frente deste combate.</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="showDengueModalBtn" class="btn bg-orange-500 text-white hover:bg-orange-600 flex-1">Aprenda mais sobre a Dengue</button>
                    <button id="showAedesModalBtn" class="btn bg-gray-700 text-white hover:bg-gray-800 flex-1">Aprenda mais sobre o Aedes Aegypti</button>
                </div>
            </div>
        </footer>
        
        <footer class="text-center mt-12 py-8 border-t-2 border-dashed border-border-color">
            <h2 class="text-4xl font-extrabold text-khaki-base glow-text">ACE FLOW</h2>
            <p class="text-text-muted mt-2">Obrigado por utilizar nossa ferramenta. Seu trabalho √© fundamental para a sa√∫de de todos.</p>
        </footer>
    </main>
    
    <!-- DATALISTS E MODAIS -->
    <datalist id="agent-suggestions"></datalist>
    <datalist id="bairro-suggestions"></datalist>
    <datalist id="street-suggestions"></datalist>

    <div id="confirmationModal" class="fixed inset-0 z-50 modal hidden">
        <div class="card p-6 w-11/12 max-w-sm text-center">
            <p id="modalMessage" class="text-lg mb-6">Tem certeza?</p>
            <div class="flex justify-center gap-4">
                <button id="modalCancelBtn" class="btn bg-gray-300 hover:bg-gray-400 text-black">Cancelar</button>
                <button id="modalConfirmBtn" class="btn bg-red-600 hover:bg-red-700 text-white">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="reportModal" class="fixed inset-0 z-50 modal hidden">
         <div class="card p-4 md:p-6 w-11/12 max-w-6xl max-h-[90vh] flex flex-col">
            <header class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="section-title">Relat√≥rios Inteligentes</h2>
                <button id="closeReportModalBtn" class="text-3xl font-bold">&times;</button>
            </header>
            <div id="reportModalBody" class="flex-grow overflow-y-auto pr-2">
                <!-- Filtros -->
                <div class="flex flex-col md:flex-row gap-4 mb-4 pb-4 border-b">
                    <div class="flex-1">
                        <label for="reportStartDate" class="font-semibold text-sm">De:</label>
                        <input type="date" id="reportStartDate" class="form-input mt-1">
                    </div>
                    <div class="flex-1">
                        <label for="reportEndDate" class="font-semibold text-sm">At√©:</label>
                        <input type="date" id="reportEndDate" class="form-input mt-1">
                    </div>
                    <div class="flex items-end">
                        <button id="searchReportBtn" class="btn bg-blue-800 text-white hover:bg-blue-900 w-full md:w-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            Pesquisar
                        </button>
                    </div>
                </div>
                <!-- Conte√∫do do Relat√≥rio -->
                <div id="reportContent" class="space-y-6">
                     <div id="no-report-data" class="text-center my-8 text-text-muted">
                        <p class="font-bold text-lg">Selecione um per√≠odo para gerar o relat√≥rio.</p>
                    </div>
                    <div id="reportDataContainer" class="hidden space-y-6">
                        <!-- Cards de dados aqui -->
                    </div>
                </div>
            </div>
            <footer id="reportFooter" class="mt-6 pt-4 border-t flex justify-end gap-3 hidden">
                <button id="downloadReportPdfBtn" class="btn bg-red-700 hover:bg-red-800 text-white">Baixar PDF</button>
            </footer>
        </div>
    </div>
    
    <div id="aiModal" class="fixed inset-0 z-50 modal hidden">
         <div class="card p-4 md:p-6 w-11/12 max-w-2xl max-h-[90vh] flex flex-col">
            <header class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 id="aiModalTitle" class="section-title">An√°lise da Intelig√™ncia Artificial</h2>
                <button id="closeAiModalBtn" class="text-3xl font-bold">&times;</button>
            </header>
            <div id="aiModalContent" class="flex-grow overflow-y-auto prose max-w-none prose-p:my-2 prose-headings:my-3">
            </div>
        </div>
    </div>
    
    <div id="sectorModal" class="fixed inset-0 z-50 modal hidden">
         <div class="card p-4 md:p-6 w-11/12 max-w-5xl max-h-[90vh] flex flex-col">
            <header class="flex justify-between items-center border-b pb-3 mb-4">
                <button id="sectorBackBtn" class="sector-back-btn hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                </button>
                <h2 id="sectorModalTitle" class="section-title flex-grow text-center">Minha √Årea de Atua√ß√£o</h2>
                <button id="closeSectorModalBtn" class="text-3xl font-bold">&times;</button>
            </header>
            <div id="sectorModalContent" class="flex-grow overflow-y-auto relative">
            </div>
        </div>
    </div>

    <!-- MODAIS DE CURIOSIDADES -->
    <div id="dengueModal" class="fixed inset-0 z-50 modal hidden"></div>
    <div id="aedesModal" class="fixed inset-0 z-50 modal hidden"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- VARI√ÅVEIS GLOBAIS ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_M9m5XNbdgaMGXF69esRYPT-xBu5yVz4b6TqUrvy85Ipx_hVh4fQUqISwtFhoMkEW/exec'; 
        const { jsPDF } = window.jspdf;
        const Chart = window.Chart;
        const INITIAL_ROWS = 15;
        const CICLOS = ['1¬∞', '2¬∞', '3¬∞', '4¬∞', '5¬∞', '6¬∞', '7¬∞', '8¬∞', '9¬∞', '10¬∞'];
        const BRAZIL_HOLIDAYS_2025 = [
            '2025-01-01', '2025-03-03', '2025-03-04', '2025-04-18', '2025-04-21',
            '2025-05-01', '2025-06-19', '2025-09-07', '2025-10-12', '2025-11-02',
            '2025-11-15', '2025-11-20', '2025-12-25',
        ];
        
        let streetList = [], agentList = [], bairroList = [];
        let visitaCounter = 0;
        let confirmCallback = null;
        let dailyGoal = 0;
        let deferredInstallPrompt = null;
        let currentReportData = null; // Armazena dados do relat√≥rio atual para exporta√ß√£o
        let sectorNavigationStack = [];

        // --- SELETORES DO DOM ---
        const landingPage = document.getElementById('landingPage');
        const startWebButton = document.getElementById('startWebButton');
        const installAppButton = document.getElementById('installAppButton');
        const installInstructions = document.getElementById('install-instructions');
        const mainContent = document.querySelector('main');
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const agenteInput = document.getElementById('agente');
        const bairroInput = document.getElementById('bairro');
        const cicloSelect = document.getElementById('ciclo');
        const dataInput = document.getElementById('data');
        const visitasContainer = document.getElementById('visitasContainer');
        const summarySection = document.getElementById('summarySection');
        const agentSuggestions = document.getElementById('agent-suggestions');
        const bairroSuggestions = document.getElementById('bairro-suggestions');
        const streetSuggestions = document.getElementById('street-suggestions');
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const reportModal = document.getElementById('reportModal');
        const reportModalBody = document.getElementById('reportModalBody');
        const closeReportModalBtn = document.getElementById('closeReportModalBtn');
        const reportStartDate = document.getElementById('reportStartDate');
        const reportEndDate = document.getElementById('reportEndDate');
        const searchReportBtn = document.getElementById('searchReportBtn');
        const reportContent = document.getElementById('reportContent');
        const noReportData = document.getElementById('no-report-data');
        const reportDataContainer = document.getElementById('reportDataContainer');
        const reportFooter = document.getElementById('reportFooter');
        const downloadReportPdfBtn = document.getElementById('downloadReportPdfBtn');
        const fixedInfoBar = document.getElementById('fixed-info-bar');
        const fixedAgentName = document.getElementById('fixed-agent-name');
        const fixedPropertyInfo = document.getElementById('fixed-property-info');
        const totalImoveisInput = document.getElementById('totalImoveis');
        const cicloInicioInput = document.getElementById('cicloInicio');
        const cicloFimInput = document.getElementById('cicloFim');
        const calculateGoalBtn = document.getElementById('calculateGoalBtn');
        const goalResultDiv = document.getElementById('goalResult');
        const dailyGoalEl = document.getElementById('dailyGoal');
        const dailyProgressEl = document.getElementById('dailyProgress');
        const progressTextEl = document.getElementById('progressText');
        const aiCombinedAnalysisBtn = document.getElementById('aiCombinedAnalysisBtn');
        const aiModal = document.getElementById('aiModal');
        const aiModalTitle = document.getElementById('aiModalTitle');
        const aiModalContent = document.getElementById('aiModalContent');
        const closeAiModalBtn = document.getElementById('closeAiModalBtn');
        const calculateVolumeBtn = document.getElementById('calculateVolumeBtn');
        const clearVolumeBtn = document.getElementById('clearVolumeBtn');
        const volumeResultDiv = document.getElementById('volumeResult');
        const volumeTextEl = document.getElementById('volumeText');
        const spoonAmountTextEl = document.getElementById('spoonAmountText');
        const gramsAmountTextEl = document.getElementById('gramsAmountText');
        const larguraInput = document.getElementById('largura');
        const comprimentoInput = document.getElementById('comprimento');
        const alturaInput = document.getElementById('altura');
        // Seletores da Minha √Årea
        const myAreaBtn = document.getElementById('myAreaBtn');
        const sectorModal = document.getElementById('sectorModal');
        const sectorModalContent = document.getElementById('sectorModalContent');
        const sectorModalTitle = document.getElementById('sectorModalTitle');
        const sectorBackBtn = document.getElementById('sectorBackBtn');
        const closeSectorModalBtn = document.getElementById('closeSectorModalBtn');
        // Seletores de Backup/Restaura√ß√£o
        const backupBtn = document.getElementById('backupBtn');
        const restoreInput = document.getElementById('restoreInput');
        // Seletores de Curiosidades
        const curiositiesBtn = document.getElementById('curiositiesBtn');
        const subButtonsContainer = document.getElementById('subButtonsContainer');
        const showDengueModalBtn = document.getElementById('showDengueModalBtn');
        const showAedesModalBtn = document.getElementById('showAedesModalBtn');
        const dengueModal = document.getElementById('dengueModal');
        const aedesModal = document.getElementById('aedesModal');

        // --- L√ìGICA DA LANDING PAGE E PWA ---
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
            installAppButton.classList.remove('hidden');
            installInstructions.classList.remove('hidden');
        });

        const showApp = () => {
            landingPage.style.display = 'none';
            loginModal.classList.remove('hidden');
            loginModal.classList.add('flex');
        };
        
        startWebButton.addEventListener('click', showApp);

        installAppButton.addEventListener('click', () => {
            if (deferredInstallPrompt) {
                deferredInstallPrompt.prompt();
                deferredInstallPrompt.userChoice.then((choiceResult) => {
                    deferredInstallPrompt = null;
                });
            } else {
                showApp();
            }
        });

        // --- FUN√á√ïES DE UTILIDADE ---
        const toTitleCase = (str) => {
            if (!str) return '';
            const lower = ['de', 'da', 'do', 'dos', 'das', 'e'];
            return str.replace(/\w\S*/g, (txt, offset) => {
                const word = txt.toLowerCase();
                if (offset > 0 && lower.includes(word)) {
                    return word;
                }
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        };

        const corrigirOrtografia = (str) => {
            if (!str) return '';
            const correcoes = {
                'sao': 'S√£o', 'sebastiao': 'Sebasti√£o', 'jose': 'Jos√©',
                'joao': 'Jo√£o', 'conceicao': 'Concei√ß√£o', 'vitoria': 'Vit√≥ria',
                'praca': 'Pra√ßa', 'acude': 'A√ßude', 'antonio': 'Ant√¥nio',
                'maria': 'Maria', 'francisco': 'Francisco', 'francisca': 'Francisca',
                'luiz': 'Luiz', 'gonzaga': 'Gonzaga', 'pereira': 'Pereira',
                'silva': 'Silva', 'souza': 'Souza', 'santos': 'Santos',
                'oliveira': 'Oliveira', 'tv': 'Tv', 'av': 'Av', 'r': 'Rua',
                'trav': 'Travessa', 'sen': 'Senador'
            };
            let correctedStr = str;
            Object.keys(correcoes).forEach(key => {
                const regex = new RegExp(`\\b${key}\\b`, 'gi');
                correctedStr = correctedStr.replace(regex, correcoes[key]);
            });
            return correctedStr;
        };
        
        const formatAndCorrectText = (str) => {
            return toTitleCase(corrigirOrtografia(str));
        }

        // --- TEMPLATES HTML ---
        const createVisitaCardHTML = (index) => `
            <div class="card visita-card" data-index="${index}">
                <header class="flex items-center justify-between p-3 cursor-pointer card-header group" data-toggle="card-content-${index}">
                    <div class="flex items-center min-w-0 flex-1">
                        <span class="flex-shrink-0 flex items-center justify-center h-8 w-8 rounded-full bg-bg-card border-2 border-khaki-base text-khaki-base font-bold mr-3">${index + 1}</span>
                        <div class="min-w-0 flex-grow">
                            <span class="logradouro-preview font-semibold truncate block">Novo Im√≥vel</span>
                            <div class="status-indicator text-sm font-semibold text-alert-red">Falta Preencher</div>
                        </div>
                    </div>
                    <span class="toggle-icon text-3xl font-bold text-khaki-base transition-transform duration-300 group-data-[expanded=true]:rotate-45">+</span>
                </header>
                <div id="card-content-${index}" class="hidden-content">
                    <div class="p-4 border-t border-border-color space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-bold text-text-muted">Bairro</label>
                                <input type="text" list="bairro-suggestions" class="form-input bairro-imovel mt-1" placeholder="Bairro do Im√≥vel">
                            </div>
                             <div>
                                <label class="text-sm font-bold text-text-muted">Logradouro/Rua</label>
                                <input type="text" list="street-suggestions" class="form-input logradouro mt-1" placeholder="Ex: Rua Jo√£o da Silva">
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-x-3">
                            <div><label class="text-sm font-bold text-text-muted">Quarteir√£o</label><input type="number" min="1" oninput="this.value=this.value.replace(/[^0-9]/g,'');" class="form-input quarteirao mt-1 text-center"></div>
                            <div><label class="text-sm font-bold text-text-muted">Lado</label><select class="form-select lado mt-1" required><option value="" disabled selected></option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                            <div><label class="text-sm font-bold text-text-muted">N¬∫</label><input type="text" inputmode="numeric" class="form-input numero mt-1 text-center is-filled" value="S/N" onfocus="if(this.value === 'S/N') this.value=''" onblur="if(this.value.trim() === '') this.value='S/N'"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-x-3">
                            <div><label class="text-sm font-bold text-text-muted">Im√≥vel</label><select class="form-select imovel mt-1" required><option value="" disabled selected></option><option value="R">Resid√™ncia</option><option value="C">Com√©rcio</option><option value="TB">Terreno Baldio</option><option value="O">Outro</option></select></div>
                            <div><label class="text-sm font-bold text-text-muted">Visita</label><select class="form-select visita mt-1" required><option value="" disabled selected></option><option value="T">Trabalhado</option><option value="P">Recuperado</option><option value="F">Fechado</option><option value="R">Recusado</option></select></div>
                        </div>
                        <div class="border-t border-border-color pt-4 mt-4">
                            <p class="text-center text-sm font-bold text-text-muted mb-2">Resultados</p>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="text-center"><label class="text-xs font-medium">Elim.</label><input type="number" min="0" oninput="this.value=this.value.replace(/[^0-9]/g,'');" class="form-input elim mt-1 text-center" placeholder="0"></div>
                                <div class="text-center"><label class="text-xs font-medium">Trat.</label><button type="button" class="toggle-check tratado mt-1"></button></div>
                                <div class="text-center"><label class="text-xs font-medium">Larvicida</label><select class="form-select gram mt-1 text-center"></select></div>
                                <div class="text-center"><label class="text-xs font-medium">Dep.</label><input type="number" min="0" oninput="this.value=this.value.replace(/[^0-9]/g,'');" class="form-input dep mt-1 text-center" placeholder="0"></div>
                                <div class="text-center"><label class="text-xs font-medium">Foco</label><button type="button" class="toggle-check foco mt-1"></button></div>
                                <div class="text-center"><label class="text-xs font-medium">Hor√°rio</label><input type="time" class="form-input horario mt-1 text-center"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // --- FUN√á√ïES PRINCIPAIS ---
        const showModal = (message, cb) => {
            modalMessage.textContent = message;
            confirmCallback = cb;
            confirmationModal.classList.remove('hidden');
        };

        const hideModal = () => {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        };

        const updateToggleHTML = (button) => {
            const isChecked = button.classList.contains('is-checked');
            if (button.matches('.foco')) button.innerHTML = isChecked ? 'X' : '';
            else if (button.matches('.tratado')) button.innerHTML = isChecked ? '‚úÖ' : '';
        };

        const populateSelects = () => {
            cicloSelect.innerHTML = `<option value="" disabled selected></option>` + CICLOS.map(c => `<option value="${c}">${c}</option>`).join('');
        };
        
        const populateGramasSelect = (selectElement) => {
            const importantValues = ['0.8', '1.6', '3.2', '6.4', '7.2', '9.6', '12.8'];
            let gramasHTML = '<option value="0.0">0.0</option>';
            for (let i = 0.4; i <= 60.0; i = parseFloat((i + 0.4).toFixed(1))) {
                const val = i.toFixed(1);
                const isImportant = importantValues.includes(val);
                gramasHTML += `<option value="${val}" ${isImportant ? 'class="important-value"' : ''}>${val}</option>`;
            }
            selectElement.innerHTML = gramasHTML;
        };
        
        const addVisitaCard = () => {
            const cardHTML = createVisitaCardHTML(visitaCounter);
            visitasContainer.insertAdjacentHTML('beforeend', cardHTML);
            const newCard = visitasContainer.lastElementChild;
            populateGramasSelect(newCard.querySelector('.gram'));
            if (visitaCounter === 0) newCard.querySelector('.bairro-imovel').focus();
            
            const prevCard = visitaCounter > 0 ? visitasContainer.children[visitaCounter - 1] : null;
            const bairroHeader = bairroInput.value;
            
            newCard.querySelector('.bairro-imovel').value = prevCard ? prevCard.querySelector('.bairro-imovel').value : bairroHeader;
            newCard.querySelector('.logradouro').value = prevCard ? prevCard.querySelector('.logradouro').value : '';
            newCard.querySelector('.quarteirao').value = prevCard ? prevCard.querySelector('.quarteirao').value : '';
            newCard.querySelector('.lado').value = prevCard ? prevCard.querySelector('.lado').value : '';

            // Set fields as filled if they have a value from replication
            ['.bairro-imovel', '.logradouro', '.quarteirao', '.lado', '.numero'].forEach(sel => {
                const input = newCard.querySelector(sel);
                if (input.value) {
                    input.classList.add('is-filled');
                }
            });

            updateCardStatus(newCard);
            visitaCounter++;
        };
        
        const updateCardStatus = (cardElement) => {
            const quarteirao = cardElement.querySelector('.quarteirao').value.trim();
            const logradouro = cardElement.querySelector('.logradouro').value.trim();
            const numero = cardElement.querySelector('.numero').value.trim() || 'S/N';
            const preview = cardElement.querySelector('.logradouro-preview');

            const quarteiraoPart = quarteirao ? `Quart. ${quarteirao}` : '';
            const logradouroPart = logradouro ? `${logradouro}, ${numero}` : '';
            const fullPreviewText = [quarteiraoPart, logradouroPart].filter(Boolean).join(' - ');
            
            preview.textContent = fullPreviewText || 'Novo Im√≥vel';

            const requiredSelectors = ['.bairro-imovel', '.logradouro', '.quarteirao', '.lado', '.numero', '.imovel', '.visita'];
            const statusIndicator = cardElement.querySelector('.status-indicator');
            const horarioInput = cardElement.querySelector('.horario');
            
            let filledCount = 0;
            let hasManualInput = false;
            requiredSelectors.forEach(sel => {
                const input = cardElement.querySelector(sel);
                if (input.value.trim() !== '') {
                   filledCount++;
                }
                if (input.dataset.manualInput === 'true') {
                   hasManualInput = true;
                }
            });

            statusIndicator.classList.remove('text-alert-red', 'text-orange-500', 'text-confirm-green');
            const isFullyFilled = filledCount >= requiredSelectors.length;
            
            if (isFullyFilled) {
                statusIndicator.textContent = '‚úÖ Preenchido';
                statusIndicator.classList.add('text-confirm-green');
                if (!horarioInput.value) {
                    const now = new Date();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    horarioInput.value = `${hours}:${minutes}`;
                    horarioInput.classList.add('is-filled');
                }
                // Automatically save to history when a card is completed
                saveCurrentDayToHistory(false);
            } else if (hasManualInput) {
                statusIndicator.textContent = 'Em Preenchimento...';
                statusIndicator.classList.add('text-orange-500'); 
            } else {
                statusIndicator.textContent = 'Falta Preencher';
                statusIndicator.classList.add('text-alert-red');
            }
        };

        const getSummaryData = () => {
            const allCards = document.querySelectorAll('.visita-card');
            const filledCards = [...allCards].filter(card => ['.logradouro', '.quarteirao', '.lado', '.imovel', '.visita'].every(sel => card.querySelector(sel).value.trim() !== ''));
            
            let summary = { recuperado: 0, fechado: 0, recusado: 0, eliminados: 0, depositosTratados: 0, tratamentoFocal: 0, larvicidaGramas: 0, focos: 0 };
            let trabalhadosSummary = { total: 0, residencia: 0, comercio: 0, terrenoBaldio: 0, outro: 0 };
            const quarteiroesSet = new Set();

            filledCards.forEach(card => {
                const imovel = card.querySelector('.imovel').value;
                const visita = card.querySelector('.visita').value;
                const quarteiraoValue = card.querySelector('.quarteirao').value.trim();

                if (quarteiraoValue && !isNaN(parseInt(quarteiraoValue))) {
                    quarteiroesSet.add(parseInt(quarteiraoValue));
                }
                
                // ATUALIZA√á√ÉO: Im√≥veis recuperados (P) agora contam como trabalhados.
                if (visita === 'T' || visita === 'P') { 
                    trabalhadosSummary.total++;
                    if (imovel === 'R') trabalhadosSummary.residencia++;
                    else if (imovel === 'C') trabalhadosSummary.comercio++;
                    else if (imovel === 'TB') trabalhadosSummary.terrenoBaldio++;
                    else if (imovel === 'O') trabalhadosSummary.outro++;
                }
                
                // Mant√©m a contagem separada para o resumo de pend√™ncias
                if (visita === 'P') { summary.recuperado++; }
                else if (visita === 'F') { summary.fechado++; }
                else if (visita === 'R') { summary.recusado++; }

                summary.eliminados += parseInt(card.querySelector('.elim').value) || 0;
                summary.depositosTratados += parseInt(card.querySelector('.dep').value) || 0;
                if (card.querySelector('.tratado').classList.contains('is-checked')) summary.tratamentoFocal++;
                summary.larvicidaGramas += parseFloat(card.querySelector('.gram').value) || 0;
                if (card.querySelector('.foco').classList.contains('is-checked')) summary.focos++;
            });

            const quarteiroesTrabalhados = quarteiroesSet.size;
            let quarteiroesConcluidos = 0;
            if (quarteiroesSet.size > 1) {
                const maxQuarteirao = Math.max(...quarteiroesSet);
                quarteiroesConcluidos = [...quarteiroesSet].filter(q => q < maxQuarteirao).length;
            }
            
            return {
                trabalhados: trabalhadosSummary,
                geral: summary,
                quarteiroes: {
                    trabalhados: quarteiroesTrabalhados,
                    concluidos: quarteiroesConcluidos
                }
            };
        };

        const renderSummary = (summaryData) => {
            const { trabalhados, geral, quarteiroes } = summaryData;

            if(dailyGoal > 0){
                const progress = Math.min((trabalhados.total / dailyGoal) * 100, 100);
                dailyProgressEl.style.width = `${progress}%`;
                progressTextEl.textContent = `${trabalhados.total} / ${dailyGoal}`;
            }

            summarySection.innerHTML = `
                <div class="col-span-full text-center border-b border-border-color pb-3 mb-4">
                    <h3 class="font-semibold text-text-muted">Detalhes dos Im√≥veis Trabalhados</h3>
                </div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${trabalhados.residencia}</p><p class="text-sm text-text-muted">Resid√™ncias</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${trabalhados.comercio}</p><p class="text-sm text-text-muted">Com√©rcios</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${trabalhados.terrenoBaldio}</p><p class="text-sm text-text-muted">Ter. Baldios</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${trabalhados.outro}</p><p class="text-sm text-text-muted">Outros</p></div>
                <div class="p-3 text-center col-span-full font-bold text-lg bg-gray-100 rounded-lg summary-item"><p>${trabalhados.total}</p><p class="text-sm font-normal text-text-muted">Total Trabalhados</p></div>

                <div class="col-span-full text-center border-t border-border-color pt-4 mt-4 pb-3 mb-4">
                    <h3 class="font-semibold text-text-muted">Resumo Geral da Produ√ß√£o</h3>
                </div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${geral.tratamentoFocal}</p><p class="text-sm text-text-muted">Trat. Focal</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${geral.larvicidaGramas.toFixed(1)}g</p><p class="text-sm text-text-muted">Larvicida</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${geral.depositosTratados}</p><p class="text-sm text-text-muted">Dep. Tratados</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${geral.eliminados}</p><p class="text-sm text-text-muted">Eliminados</p></div>
                <div class="p-3 text-center col-span-full text-red-600 font-bold text-2xl">${geral.focos} <span class="text-sm text-red-600">Total de Focos</span></div>
                
                <div class="col-span-full flex justify-center flex-wrap gap-4">
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${geral.recusado}</p><p class="text-sm text-text-muted">Recusados</p></div>
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${geral.fechado}</p><p class="text-sm text-text-muted">Fechados</p></div>
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${geral.recuperado}</p><p class="text-sm text-text-muted">Recuperados</p></div>
                </div>

                <div class="col-span-full flex justify-center gap-4">
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${quarteiroes.trabalhados}</p><p class="text-sm text-text-muted">Quarteir√µes Trabalhados</p></div>
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${quarteiroes.concluidos}</p><p class="text-sm text-text-muted">Quarteir√µes Conclu√≠dos</p></div>
                </div>
            `;
        };
        
        const updateAndRenderSummary = () => {
            const summaryData = getSummaryData();
            renderSummary(summaryData);
        };

        const calculateWorkingDays = (startDate, endDate) => {
            let count = 0;
            const curDate = new Date(startDate.getTime());
            while (curDate <= endDate) {
                const dayOfWeek = curDate.getUTCDay();
                const dateString = curDate.toISOString().slice(0, 10);
                if (dayOfWeek !== 0 && dayOfWeek !== 6 && !BRAZIL_HOLIDAYS_2025.includes(dateString)) count++;
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        };

        const handleGoalCalculation = () => {
            const totalImoveis = parseInt(totalImoveisInput.value);
            const inicio = cicloInicioInput.value;
            const fim = cicloFimInput.value;
            if (totalImoveis > 0 && inicio && fim) {
                const workingDays = calculateWorkingDays(new Date(inicio + 'T00:00:00'), new Date(fim + 'T00:00:00'));
                if(workingDays > 0) {
                    dailyGoal = Math.ceil(totalImoveis / workingDays);
                    dailyGoalEl.textContent = dailyGoal;
                    goalResultDiv.classList.remove('hidden');
                    updateAndRenderSummary();
                    localStorage.setItem('aceFlowGoalData', JSON.stringify({ totalImoveis, inicio, fim, dailyGoal }));
                } else { alert("O per√≠odo selecionado n√£o cont√©m dias √∫teis."); }
            } else { alert("Por favor, preencha todos os campos do setor."); }
        };

        const loadGoalData = () => {
            const goalData = JSON.parse(localStorage.getItem('aceFlowGoalData'));
            if (goalData) {
                totalImoveisInput.value = goalData.totalImoveis;
                cicloInicioInput.value = goalData.inicio;
                cicloFimInput.value = goalData.fim;
                dailyGoal = goalData.dailyGoal;
                dailyGoalEl.textContent = dailyGoal;
                goalResultDiv.classList.remove('hidden');
                document.getElementById('goalModule').open = true;
            }
        };

        const saveData = () => {
             const data = {
                 header: { agente: agenteInput.value, bairro: bairroInput.value, ciclo: cicloSelect.value, data: dataInput.value },
                 visits: []
             };
             document.querySelectorAll('.visita-card').forEach(card => {
                 data.visits.push({
                     bairro: card.querySelector('.bairro-imovel').value,
                     logradouro: card.querySelector('.logradouro').value, 
                     quarteirao: card.querySelector('.quarteirao').value,
                     lado: card.querySelector('.lado').value, 
                     numero: card.querySelector('.numero').value,
                     imovel: card.querySelector('.imovel').value, 
                     visita: card.querySelector('.visita').value,
                     elim: card.querySelector('.elim').value, 
                     trat: card.querySelector('.tratado').classList.contains('is-checked'),
                     gram: card.querySelector('.gram').value, 
                     dep: card.querySelector('.dep').value,
                     foco: card.querySelector('.foco').classList.contains('is-checked'),
                     horario: card.querySelector('.horario').value,
                     isExpanded: card.querySelector('.card-header').getAttribute('data-expanded') === 'true'
                 });
             });
             localStorage.setItem('aceFlowDailyData', JSON.stringify(data));
        };
        
        const loadData = () => {
            const data = JSON.parse(localStorage.getItem('aceFlowDailyData'));
            visitasContainer.innerHTML = '';
            visitaCounter = 0;
            const rowsToCreate = (data && data.visits.length > INITIAL_ROWS) ? data.visits.length : INITIAL_ROWS;
            for(let i = 0; i < rowsToCreate; i++) addVisitaCard();
            if (!data) return;
            agenteInput.value = data.header.agente || agenteInput.value;
            bairroInput.value = data.header.bairro || '';
            cicloSelect.value = data.header.ciclo || '';
            
            // Correct date initialization
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dataInput.value = data.header.data || `${year}-${month}-${day}`;

            [agenteInput, bairroInput, cicloSelect, dataInput].forEach(el => { if(el.value) el.classList.add('is-filled'); });
            data.visits.forEach((visitData, index) => {
                const card = visitasContainer.children[index];
                if (!card) return;
                Object.keys(visitData).forEach(key => {
                    const selector = key === 'bairro' ? '.bairro-imovel' : `.${key}`;
                    const el = card.querySelector(selector);
                    if (el) {
                        if (el.classList.contains('toggle-check')) { if(visitData[key]) el.classList.add('is-checked');}
                        else { el.value = visitData[key]; }
                    }
                });
                updateToggleHTML(card.querySelector('.foco'));
                updateToggleHTML(card.querySelector('.tratado'));
                if (visitData.isExpanded === "true") {
                    const header = card.querySelector('.card-header');
                    header.setAttribute('data-expanded', 'true');
                    header.nextElementSibling.classList.add('show');
                }
                updateCardStatus(card);
            });
        };
        
        const saveCurrentDayToHistory = (showSuccessAlert = true) => {
            const dailyData = JSON.parse(localStorage.getItem('aceFlowDailyData'));
            if (!dailyData || !dailyData.header.data) {
                if (showSuccessAlert) alert("N√£o h√° dados do dia para salvar.");
                return false;
            }
            
            const filledVisits = dailyData.visits.filter(v => v.logradouro && v.quarteirao && v.numero && v.lado && v.imovel && v.visita);
            if (filledVisits.length === 0) {
                if (showSuccessAlert) alert("Nenhum im√≥vel preenchido para salvar no hist√≥rico.");
                return false;
            }

            let history = JSON.parse(localStorage.getItem('aceFlowHistory')) || [];
            history = history.filter(entry => entry.header.data !== dailyData.header.data);
            history.push(dailyData);
            localStorage.setItem('aceFlowHistory', JSON.stringify(history));
            
            updateSectorData(dailyData);

            if (showSuccessAlert) alert('Dados do dia salvos no hist√≥rico com sucesso!');
            return true;
        };

        const generateDailyPDF = () => {
            if (!saveCurrentDayToHistory(true)) return; // Salva com alerta antes de gerar o PDF

            const doc = new jsPDF();
            const data = JSON.parse(localStorage.getItem('aceFlowDailyData'));
            if (!data) return;

            const filledVisits = data.visits.filter(v => 
                v.logradouro && v.quarteirao && v.numero && v.lado && v.imovel && v.visita
            );

            if (filledVisits.length === 0) {
                return;
            }

            const { agente, bairro, ciclo, data: workDate } = data.header;
            const dateFormatted = new Date(workDate + 'T12:00:00').toLocaleDateString('pt-BR');
            
            const primaryColor = '#111827';
            const headerFooterColor = '#9CA3AF';

            doc.setFont('helvetica', 'normal');
            doc.setFillColor(primaryColor);
            doc.rect(0, 0, 210, 25, 'F');
            doc.setFontSize(22);
            doc.setTextColor('#FFFFFF');
            doc.setFont('helvetica', 'bold');
            doc.text("ACE FLOW", 15, 17);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text("Relat√≥rio de Atividades Di√°rias", 105, 17, { align: 'center' });

            doc.autoTable({
                startY: 30,
                theme: 'plain',
                body: [
                    [{content: 'Agente:', styles: {fontStyle: 'bold', textColor: primaryColor}}, agente],
                    [{content: 'Data:', styles: {fontStyle: 'bold', textColor: primaryColor}}, dateFormatted],
                    [{content: 'Bairro Principal:', styles: {fontStyle: 'bold', textColor: primaryColor}}, bairro],
                    [{content: 'Ciclo:', styles: {fontStyle: 'bold', textColor: primaryColor}}, ciclo]
                ],
                styles: { fontSize: 16 }
            });
            
            const summaryData = getSummaryData();
            const { trabalhados, geral, quarteiroes } = summaryData;
            
            const detalhesData = [
                ['Resid√™ncias', trabalhados.residencia], ['Com√©rcios', trabalhados.comercio],
                ['Ter. Baldios', trabalhados.terrenoBaldio], ['Outros', trabalhados.outro],
                [{content: 'Total Trabalhados', styles: {fontStyle: 'bold'}}, {content: trabalhados.total, styles: {fontStyle: 'bold'}}]
            ];
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 8,
                head: [['Detalhes dos Im√≥veis Trabalhados', 'Total']],
                body: detalhesData,
                headStyles: { fillColor: primaryColor, fontSize: 16 },
                styles: { fontSize: 16, cellPadding: 3 },
            });

            const producaoData = [
                ['Tratamento Focal', geral.tratamentoFocal],
                ['Quantidade de Larvicida', `${geral.larvicidaGramas.toFixed(1)}g`],
                ['Dep√≥sitos Tratados', geral.depositosTratados],
                ['Eliminados', geral.eliminados],
                ['Quarteir√µes Trabalhados', quarteiroes.trabalhados],
                ['Quarteir√µes Conclu√≠dos', quarteiroes.concluidos],
                ['Total de Focos', geral.focos],
                ['Recusados', geral.recusado],
                ['Fechados', geral.fechado],
                ['Recuperados', geral.recuperado]
            ];
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [['Resumo Geral da Produ√ß√£o', 'Total']],
                body: producaoData,
                headStyles: { fillColor: primaryColor, fontSize: 16 },
                styles: { fontSize: 16, cellPadding: 3 },
                willDrawCell: function(data) {
                    if (data.section === 'body' && data.cell.text[0] === 'Total de Focos') {
                        data.cell.styles.textColor = '#e74c3c';
                        data.cell.styles.fontStyle = 'bold';
                        if (data.row.cells[1]) {
                            data.row.cells[1].styles.textColor = '#e74c3c';
                            data.row.cells[1].styles.fontStyle = 'bold';
                        }
                    }
                },
            });
            
            const visitaMap = { T: 'Trab.', P: 'Recuperado', F: 'Fechado', R: 'Recusado' };
            const visitData = filledVisits.map((v, i) => [
                i + 1, v.bairro, v.logradouro, v.quarteirao, v.numero, visitaMap[v.visita] || v.visita, v.horario || ''
            ]);
            doc.autoTable({
                head: [['#', 'Bairro', 'Logradouro', 'Quart.', 'N¬∫', 'Visita', 'Hor√°rio']], 
                body: visitData,
                startY: doc.lastAutoTable.finalY + 10,
                headStyles: { fillColor: '#6B7280', fontSize: 12 },
                styles: { fontSize: 10 },
            });
            
            doc.save(`ACE_FLOW_${agente.split(' ')[0]}_${workDate}.pdf`);
        };
        
        const updateAutocomplete = (type, value) => {
            let list, datalist;
            if (type === 'agent') { list = agentList; datalist = agentSuggestions; } 
            else if (type === 'bairro') { list = bairroList; datalist = bairroSuggestions; } 
            else { list = streetList; datalist = streetSuggestions; }
            const trimmedValue = value.trim();
            if (trimmedValue && !list.includes(trimmedValue)) {
                list.push(trimmedValue);
                datalist.innerHTML = list.map(item => `<option value="${item}"></option>`).join('');
                localStorage.setItem(`aceFlow${type}List`, JSON.stringify(list));
            }
        };
        
        const callAiAPI = async (prompt) => {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody.error.message}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.warn("Resposta da API de IA com estrutura inesperada:", result);
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        return `O conte√∫do n√£o p√¥de ser gerado. Motivo: ${result.promptFeedback.blockReason}`;
                    }
                    return "N√£o foi poss√≠vel obter uma resposta da IA. A estrutura da resposta estava vazia.";
                }
            } catch (error) {
                console.error("Erro ao chamar a API de IA:", error);
                return `Erro de comunica√ß√£o com a IA. Por favor, verifique sua conex√£o com a internet. Detalhes: ${error.message}`;
            }
        };
        
        const handleAiCombinedAnalysis = async () => {
            aiModalTitle.textContent = "An√°lise e Plano Estrat√©gico";
            aiModalContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
            aiModal.classList.remove('hidden');

            const summaryData = getSummaryData();
            const visitData = JSON.parse(localStorage.getItem('aceFlowDailyData'))?.visits || [];
            const filledVisits = visitData.filter(v => v.logradouro && v.visita);

            const prompt = `
                Voc√™ √© um supervisor de sa√∫de p√∫blica e epidemiologista. Sua miss√£o √© criar um relat√≥rio consolidado para um Agente de Combate a Endemias. O relat√≥rio deve ter duas se√ß√µes claras, formatadas em Markdown:

                1.  **An√°lise de Desempenho do Dia:**
                    * Com base nos dados de resumo do dia, escreva um resumo narrativo em 2 par√°grafos.
                    * Destaque as conquistas (ex: n√∫mero de im√≥veis trabalhados, quarteir√µes conclu√≠dos, poucos focos).
                    * Aponte √°reas que precisam de aten√ß√£o (ex: focos encontrados, recusas, im√≥veis fechados).
                    * Termine com uma nota positiva e encorajadora.

                2.  **Plano de A√ß√£o Estrat√©gico para Amanh√£:**
                    * Com base na lista de visitas, identifique hotspots de focos, padr√µes de tratamento e pend√™ncias cr√≠ticas (im√≥veis fechados perto de focos).
                    * Crie um plano de a√ß√£o pr√°tico em bullet points, com as seguintes subse√ß√µes:
                        * **Prioridade 1 (Alerta Vermelho):** Ruas/quarteir√µes com focos para varredura intensiva.
                        * **Prioridade 2 (Aten√ß√£o):** √Åreas com muitos tratamentos ou pend√™ncias, sugerindo hor√°rios alternativos para revisita.
                        * **Continuidade:** Qual quarteir√£o continuar no ciclo normal.

                **Dados para An√°lise:**
                -   **Resumo do Dia:** ${JSON.stringify(summaryData, null, 2)}
                -   **Lista de Visitas para Planejamento:** ${JSON.stringify(filledVisits.map(({bairro, logradouro, quarteirao, visita, foco, trat}) => ({bairro, logradouro, quarteirao, visita, foco, trat})), null, 2)}
            `;
            const result = await callAiAPI(prompt);
            aiModalContent.innerHTML = result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        };

        const animateValue = (element, start, end, duration, isFloat = false) => {
            if (!element) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentValue = progress * (end - start) + start;
                element.textContent = isFloat ? currentValue.toFixed(1) : Math.floor(currentValue);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                     element.textContent = isFloat ? end.toFixed(1) : end;
                }
            };
            window.requestAnimationFrame(step);
        };

        const renderReports = async () => {
            const startDate = reportStartDate.value;
            const endDate = reportEndDate.value;
            
            if (!startDate || !endDate) {
                alert("Por favor, selecione um per√≠odo de in√≠cio e fim.");
                return;
            }

            const history = JSON.parse(localStorage.getItem('aceFlowHistory')) || [];
            
            const filteredHistory = history.filter(entry => {
                const entryDate = entry.header.data;
                return entryDate >= startDate && entryDate <= endDate;
            });

            const allVisits = filteredHistory.flatMap(entry => 
                entry.visits.filter(v => v.logradouro && v.quarteirao && v.numero && v.lado && v.imovel && v.visita)
            );

            if (allVisits.length === 0) {
                noReportData.innerHTML = `<p class="font-bold text-lg">Nenhum dado encontrado para o per√≠odo selecionado.</p>`;
                noReportData.classList.remove('hidden');
                reportDataContainer.classList.add('hidden');
                reportFooter.classList.add('hidden');
                return;
            }
            
            noReportData.classList.add('hidden');
            reportDataContainer.classList.remove('hidden');
            reportFooter.classList.remove('hidden');

            const summary = allVisits.reduce((acc, v) => {
                if (v.visita === 'T' || v.visita === 'P') {
                    acc.trabalhado++;
                    if (v.imovel === 'R') acc.residencia++;
                    else if (v.imovel === 'C') acc.comercio++;
                    else if (v.imovel === 'TB') acc.terrenoBaldio++;
                    else if (v.imovel === 'O') acc.outro++;
                }
                else if (v.visita === 'F') acc.fechado++;
                else if (v.visita === 'R') acc.recusado++;
                
                if (v.foco) {
                    acc.focos++;
                    acc.hotspots.push({
                        bairro: v.bairro,
                        quarteirao: v.quarteirao,
                        logradouro: v.logradouro,
                        numero: v.numero,
                        tipo: v.imovel
                    });
                }

                if (v.trat) acc.tratamentoFocal++;
                acc.gramas += parseFloat(v.gram) || 0;
                acc.depositosTratados += parseInt(v.dep) || 0;
                acc.eliminados += parseInt(v.elim) || 0;
                
                return acc;
            }, { 
                trabalhado: 0, fechado: 0, recusado: 0, focos: 0, gramas: 0, tratamentoFocal: 0, 
                depositosTratados: 0, eliminados: 0, residencia: 0, comercio: 0, terrenoBaldio: 0, outro: 0,
                hotspots: [] 
            });
            
            currentReportData = summary;

            const createCard = (title, value, unit = '', colorClass = 'text-gray-800', delay = 0, isFloat = false) => {
                const cardId = `report-card-${title.replace(/[^a-zA-Z0-9]/g, '-')}`;
                return `
                    <div class="report-card text-center" style="animation-delay: ${delay}ms;">
                        <h3 class="report-card-title">${title}</h3>
                        <p class="${colorClass}">
                            <span id="${cardId}" class="report-card-value">0</span>
                            <span class="report-card-unit">${unit}</span>
                        </p>
                    </div>
                `;
            };

            reportDataContainer.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold mb-4 text-center text-gray-700">Detalhes dos Im√≥veis Trabalhados</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        ${createCard('Resid√™ncias', summary.residencia, '', 'text-blue-600', 0)}
                        ${createCard('Com√©rcios', summary.comercio, '', 'text-purple-600', 50)}
                        ${createCard('Ter. Baldios', summary.terrenoBaldio, '', 'text-yellow-600', 100)}
                        ${createCard('Outros', summary.outro, '', 'text-gray-600', 150)}
                        ${createCard('Total', summary.trabalhado, '', 'text-green-600 font-black', 200)}
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4 text-center text-gray-700">Resumo da Produ√ß√£o</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${createCard('Trat. Focal', summary.tratamentoFocal, '', 'text-indigo-600', 250)}
                        ${createCard('Larvicida', summary.gramas, 'g', 'text-teal-600', 300, true)}
                        ${createCard('Dep. Tratados', summary.depositosTratados, '', 'text-cyan-600', 350)}
                        ${createCard('Eliminados', summary.eliminados, '', 'text-lime-600', 400)}
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4 text-center text-gray-700">Situa√ß√£o das Visitas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${createCard('Fechados', summary.fechado, '', 'text-gray-500', 450)}
                        ${createCard('Recusados', summary.recusado, '', 'text-orange-600', 500)}
                        ${createCard('Focos', summary.focos, '', 'text-red-600 font-black', 550)}
                    </div>
                </div>
                <div id="hotspotContainer" class="card p-4">
                    <h3 class="font-bold text-lg text-center mb-2 text-red-600">Pontos de Aten√ß√£o (Focos)</h3>
                    <div id="hotspotContent"></div>
                </div>
                <div class="card p-4">
                    <h3 class="font-bold text-lg text-center mb-2 text-blue-600">An√°lise Inteligente do Per√≠odo ‚ú®</h3>
                    <div id="aiReportContent" class="prose max-w-none prose-p:my-2 prose-headings:my-3"></div>
                </div>
            `;
            
            // Animate values
            animateValue(document.getElementById('report-card-Resid√™ncias'), 0, summary.residencia, 1000);
            animateValue(document.getElementById('report-card-Com√©rcios'), 0, summary.comercio, 1000);
            animateValue(document.getElementById('report-card-Ter--Baldios'), 0, summary.terrenoBaldio, 1000);
            animateValue(document.getElementById('report-card-Outros'), 0, summary.outro, 1000);
            animateValue(document.getElementById('report-card-Total'), 0, summary.trabalhado, 1000);
            animateValue(document.getElementById('report-card-Trat--Focal'), 0, summary.tratamentoFocal, 1000);
            animateValue(document.getElementById('report-card-Larvicida'), 0, summary.gramas, 1000, true);
            animateValue(document.getElementById('report-card-Dep--Tratados'), 0, summary.depositosTratados, 1000);
            animateValue(document.getElementById('report-card-Eliminados'), 0, summary.eliminados, 1000);
            animateValue(document.getElementById('report-card-Fechados'), 0, summary.fechado, 1000);
            animateValue(document.getElementById('report-card-Recusados'), 0, summary.recusado, 1000);
            animateValue(document.getElementById('report-card-Focos'), 0, summary.focos, 1000);


            // Render Hotspots
            const hotspotContent = document.getElementById('hotspotContent');
            const imovelMap = { 'R': 'Resid√™ncia', 'C': 'Com√©rcio', 'TB': 'Terreno Baldio', 'O': 'Outro' };
            if (summary.hotspots.length > 0) {
                let hotspotHTML = '<ul class="list-none space-y-3">';
                summary.hotspots.forEach(foco => {
                    hotspotHTML += `<li class="p-3 bg-red-50 border-l-4 border-red-500 rounded"><span class="font-bold text-red-700">Foco Encontrado:</span><br><span class="text-gray-800">Bairro: <strong>${foco.bairro}</strong>, Quart.: <strong>${foco.quarteirao}</strong><br>Endere√ßo: <strong>${foco.logradouro}, ${foco.numero}</strong><br>Tipo: <strong>${imovelMap[foco.tipo] || foco.tipo}</strong></span></li>`;
                });
                hotspotHTML += '</ul>';
                hotspotContent.innerHTML = hotspotHTML;
            } else {
                hotspotContent.innerHTML = '<p class="text-center text-green-600 font-semibold">Nenhum foco encontrado no per√≠odo. Excelente trabalho!</p>';
            }

            // Render AI Analysis
            const aiReportContent = document.getElementById('aiReportContent');
            aiReportContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
            const prompt = `
                Voc√™ √© um supervisor de sa√∫de p√∫blica analisando os dados de um Agente de Combate a Endemias para o per√≠odo de ${startDate} a ${endDate}.
                Com base no resumo de dados a seguir, escreva uma an√°lise profissional e elaborada em 2 ou 3 par√°grafos.
                Destaque os pontos positivos (ex: alto n√∫mero de im√≥veis trabalhados, poucos focos), identifique os pontos de aten√ß√£o (ex: alta incid√™ncia de focos em certas √°reas, muitas recusas) e conclua com recomenda√ß√µes estrat√©gicas para o agente.
                Seja t√©cnico, mas claro. Formate usando Markdown.

                Dados do per√≠odo:
                ${JSON.stringify(summary)}
            `;
            const aiResult = await callAiAPI(prompt);
            aiReportContent.innerHTML = aiResult.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        };
        
        const handleVolumeCalculation = () => {
            const getDimensionInMeters = (valueId, unitId) => {
                const value = parseFloat(document.getElementById(valueId).value);
                const unit = document.getElementById(unitId).value;
                if (isNaN(value) || value <= 0) return NaN;
                return unit === 'cm' ? value / 100 : value;
            };
        
            const largura = getDimensionInMeters('largura', 'larguraUnidade');
            const comprimento = getDimensionInMeters('comprimento', 'comprimentoUnidade');
            const altura = getDimensionInMeters('altura', 'alturaUnidade');
        
            if (isNaN(largura) || isNaN(comprimento) || isNaN(altura)) {
                alert("Por favor, insira valores v√°lidos e positivos para todas as dimens√µes.");
                return;
            }
            
            const volumeM3 = largura * comprimento * altura;
            const volumeLitros = volumeM3 * 1000;
            
            let gramas;
            if (volumeLitros <= 100) {
                gramas = volumeLitros * 0.008; 
            } else {
                gramas = volumeLitros * 0.0064;
            }
            
            const colheres = gramas / 0.8;
        
            let colheresText;
            if (colheres <= 0.5) {
                colheresText = "Meia colher";
            } else if (colheres <= 1) {
                colheresText = "1 colher";
            } else {
                colheresText = `${colheres.toLocaleString('pt-BR', {maximumFractionDigits: 1})} colheres`;
            }
        
            const waterLevelEl = document.getElementById('waterLevel');
            const volumeTextEl = document.getElementById('volumeText');
            const spoonAmountTextEl = document.getElementById('spoonAmountText');
            const gramsAmountTextEl = document.getElementById('gramsAmountText');
            
            volumeTextEl.textContent = `${volumeLitros.toLocaleString('pt-BR', {maximumFractionDigits: 1})} L`;
            spoonAmountTextEl.textContent = colheresText;
            gramsAmountTextEl.textContent = parseFloat(gramas.toFixed(1)).toLocaleString('pt-BR');
        
            const percentage = Math.min((volumeLitros / 2000) * 100, 100);
            waterLevelEl.style.height = `${percentage}%`;
        
            volumeResultDiv.classList.remove('hidden');
        };
        
        const clearVolumeCalculation = () => {
            larguraInput.value = '';
            comprimentoInput.value = '';
            alturaInput.value = '';
            document.getElementById('larguraUnidade').value = 'm';
            document.getElementById('comprimentoUnidade').value = 'm';
            document.getElementById('alturaUnidade').value = 'm';
            volumeResultDiv.classList.add('hidden');
        };

        const updateSectorData = (dailyData) => {
            const username = document.getElementById('username').value;
            if (!username) return;

            const sectorKey = `aceFlowSectorData_${username}`;
            let sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };

            for (const visit of dailyData.visits) {
                if (visit.bairro && visit.quarteirao && visit.logradouro && visit.numero && visit.imovel) {
                    const propertyId = `${visit.bairro}-${visit.quarteirao}-${visit.logradouro}-${visit.numero}-${visit.imovel}`.toLowerCase().replace(/\s+/g, '-');
                    
                    if (!sectorData.properties[propertyId]) {
                         sectorData.properties[propertyId] = {
                            bairro: visit.bairro,
                            quarteirao: visit.quarteirao,
                            logradouro: visit.logradouro,
                            numero: visit.numero,
                            tipo: visit.imovel // Store property type
                        };
                    }
                }
            }
            localStorage.setItem(sectorKey, JSON.stringify(sectorData));
        };

        const displayMyArea = () => {
            sectorNavigationStack = [];
            renderNeighborhoods();
            sectorModal.classList.remove('hidden');
        };

        const renderNeighborhoods = () => {
            const username = document.getElementById('username').value;
            const sectorKey = `aceFlowSectorData_${username}`;
            const sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };
            const properties = Object.values(sectorData.properties);

            const neighborhoods = [...new Set(properties.map(p => p.bairro))];
            
            let contentHTML = '<div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sector-view">';
            if (neighborhoods.length > 0) {
                neighborhoods.forEach(bairro => {
                    contentHTML += `<button class="btn bg-white hover:bg-gray-100 border-2 border-khaki-base text-khaki-base text-lg p-6 sector-neighborhood-btn" data-bairro="${bairro}">${bairro}</button>`;
                });
            } else {
                contentHTML += '<p class="col-span-full text-center text-text-muted">Nenhum bairro cadastrado ainda. Comece a registrar seus im√≥veis preenchidos.</p>';
            }
            contentHTML += '</div>';

            sectorModalTitle.textContent = "Minha √Årea: Bairros";
            sectorModalContent.innerHTML = contentHTML;
            sectorBackBtn.classList.add('hidden');
        };

        const renderBlocks = (bairro) => {
            sectorNavigationStack.push({ view: 'neighborhoods' });
            const username = document.getElementById('username').value;
            const sectorKey = `aceFlowSectorData_${username}`;
            const sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };
            const properties = Object.values(sectorData.properties).filter(p => p.bairro === bairro);
            const blocks = [...new Set(properties.map(p => p.quarteirao))].sort((a,b) => a-b);

            let contentHTML = `<div class="p-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 sector-view">`;
            blocks.forEach(block => {
                contentHTML += `<button class="btn bg-white hover:bg-gray-100 border-2 border-indigo-500 text-indigo-700 text-lg p-6 sector-block-btn" data-bairro="${bairro}" data-block="${block}">Q. ${block}</button>`;
            });
            contentHTML += '</div>';

            sectorModalTitle.textContent = `Bairro: ${bairro}`;
            sectorModalContent.innerHTML = contentHTML;
            sectorBackBtn.classList.remove('hidden');
        };

        const renderProperties = (bairro, block) => {
            sectorNavigationStack.push({ view: 'blocks', bairro: bairro });
            const username = document.getElementById('username').value;
            const sectorKey = `aceFlowSectorData_${username}`;
            const sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };
            const properties = Object.values(sectorData.properties).filter(p => p.bairro === bairro && p.quarteirao === block);
            const imovelMap = { 'R': 'Resid√™ncia', 'C': 'Com√©rcio', 'TB': 'Terreno Baldio', 'O': 'Outro' };

            let tableHTML = `
                <div class="p-4 sector-view">
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Logradouro</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N√∫mero</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="sector-table-body" class="bg-white divide-y divide-gray-200">
            `;
            properties.forEach(prop => {
                const propertyId = `${prop.bairro}-${prop.quarteirao}-${prop.logradouro}-${prop.numero}-${prop.tipo}`.toLowerCase().replace(/\s+/g, '-');
                tableHTML += `
                    <tr data-id="${propertyId}">
                        <td class="px-6 py-4 whitespace-nowrap">${prop.logradouro}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${prop.numero}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${imovelMap[prop.tipo] || prop.tipo}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="delete-property-btn text-red-600 hover:text-red-900" data-id="${propertyId}">Excluir</button>
                        </td>
                    </tr>
                `;
            });
            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            sectorModalTitle.textContent = `Bairro: ${bairro} - Quarteir√£o: ${block}`;
            sectorModalContent.innerHTML = tableHTML;
            sectorBackBtn.classList.remove('hidden');
        };

        const generatePropertyRowHTML = (prop) => {
            const propertyId = `${prop.bairro}-${prop.quarteirao}-${prop.logradouro}-${prop.numero}-${prop.tipo}`.toLowerCase().replace(/\s+/g, '-');
            const imovelMap = { 'R': 'Resid√™ncia', 'C': 'Com√©rcio', 'TB': 'Terreno Baldio', 'O': 'Outro' };
            return `
                <tr data-id="${propertyId}">
                    <td class="px-6 py-4 whitespace-nowrap">${prop.bairro}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${prop.quarteirao}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${prop.logradouro}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${prop.numero}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${imovelMap[prop.tipo] || prop.tipo}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="delete-property-btn text-red-600 hover:text-red-900" data-id="${propertyId}">Excluir</button>
                    </td>
                </tr>
            `;
        }


        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            loginError.textContent = "";
            if (!user || !pass) { loginError.textContent = "Por favor, preencha usu√°rio e senha."; return; }
            loginBtn.disabled = true; loginBtn.textContent = "Verificando...";
            const authPayload = { action: 'authenticate', usuario: user, senha: pass };
            fetch(SCRIPT_URL, {
                method: 'POST', headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                body: JSON.stringify(authPayload)
            }).then(res => res.json()).then(result => {
                if (result.status === 'success') {
                    loginModal.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    fixedInfoBar.classList.remove('hidden');
                    agenteInput.value = user;
                    agenteInput.classList.add('is-filled');
                    fixedAgentName.textContent = user;
                    loadData(); 
                    updateAndRenderSummary();
                } else { loginError.textContent = result.message || "Usu√°rio ou senha inv√°lidos."; }
            }).catch(error => {
                console.error("Erro de autentica√ß√£o:", error);
                loginError.textContent = "Erro de conex√£o. Tente novamente.";
            }).finally(() => {
                loginBtn.disabled = false; loginBtn.textContent = "Entrar";
            });
        });
        
        calculateGoalBtn.addEventListener('click', handleGoalCalculation);
        calculateVolumeBtn.addEventListener('click', handleVolumeCalculation);
        clearVolumeBtn.addEventListener('click', clearVolumeCalculation);
        document.getElementById('addVisitaBtn').addEventListener('click', addVisitaCard);
        document.getElementById('savePdfBtn').addEventListener('click', generateDailyPDF);
        
        document.getElementById('clearDayBtn').addEventListener('click', () => {
            showModal("Tem certeza que deseja limpar os dados do dia? Esta a√ß√£o N√ÉO salva os dados no hist√≥rico. Use 'Gerar PDF' para salvar e finalizar o dia.", () => {
                localStorage.removeItem('aceFlowDailyData');
                location.reload();
            });
        });
        
        aiCombinedAnalysisBtn.addEventListener('click', handleAiCombinedAnalysis);
        closeAiModalBtn.addEventListener('click', () => aiModal.classList.add('hidden'));
        myAreaBtn.addEventListener('click', displayMyArea);
        closeSectorModalBtn.addEventListener('click', () => sectorModal.classList.add('hidden'));

        document.getElementById('reportBtn').addEventListener('click', () => {
            reportModal.classList.remove('hidden');
        });

        closeReportModalBtn.addEventListener('click', () => reportModal.classList.add('hidden'));

        searchReportBtn.addEventListener('click', renderReports);
        
        downloadReportPdfBtn.addEventListener('click', () => {
            if (!currentReportData) {
                alert("Gere um relat√≥rio primeiro para poder baixar o PDF.");
                return;
            }

            const doc = new jsPDF();
            const summary = currentReportData;
            const startDate = reportStartDate.value;
            const endDate = reportEndDate.value;
            const agentName = agenteInput.value;
            
            const primaryColor = '#111827';
            const headerFooterColor = '#9CA3AF';
            const pageHeight = doc.internal.pageSize.height;
            let finalY = 0;

            // Fun√ß√£o para adicionar cabe√ßalho e rodap√©
            const addHeaderFooter = () => {
                const pageCount = doc.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    // Cabe√ßalho
                    doc.setFillColor(primaryColor);
                    doc.rect(0, 0, 210, 20, 'F');
                    doc.setFontSize(18);
                    doc.setTextColor('#FFFFFF');
                    doc.setFont('helvetica', 'bold');
                    doc.text("Relat√≥rio Inteligente de Per√≠odo", 105, 12, { align: 'center' });
                    // Rodap√©
                    doc.setFontSize(8);
                    doc.setTextColor(headerFooterColor);
                    doc.text(`P√°gina ${i} de ${pageCount}`, 105, pageHeight - 10, { align: 'center' });
                    doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 15, pageHeight - 10);
                }
            };
            
            // T√≠tulo principal
            doc.setFontSize(16);
            doc.setTextColor(primaryColor);
            doc.setFont('helvetica', 'bold');
            doc.text(`Agente: ${agentName}`, 15, 30);
            doc.setFont('helvetica', 'normal');
            doc.text(`Per√≠odo: ${new Date(startDate + 'T12:00:00').toLocaleDateString('pt-BR')} a ${new Date(endDate + 'T12:00:00').toLocaleDateString('pt-BR')}`, 15, 38);

            const tableOptions = {
                styles: { fontSize: 16, cellPadding: 3 },
                headStyles: { fillColor: primaryColor, textColor: '#FFFFFF', fontSize: 16, fontStyle: 'bold' },
                bodyStyles: { textColor: '#374151' },
                alternateRowStyles: { fillColor: '#F3F4F6' },
                startY: 45,
                margin: { left: 15, right: 15 },
            };

            // Tabela 1: Detalhes dos Im√≥veis
            doc.autoTable({
                ...tableOptions,
                head: [['Detalhes dos Im√≥veis Trabalhados', 'Total']],
                body: [
                    ['Resid√™ncias', summary.residencia],
                    ['Com√©rcios', summary.comercio],
                    ['Terrenos Baldios', summary.terrenoBaldio],
                    ['Outros', summary.outro],
                    [{ content: 'Total Trabalhados', styles: { fontStyle: 'bold' } }, { content: summary.trabalhado, styles: { fontStyle: 'bold' } }]
                ],
            });
            finalY = doc.lastAutoTable.finalY;

            // Tabela 2: Resumo da Produ√ß√£o
            doc.autoTable({
                ...tableOptions,
                startY: finalY + 10,
                head: [['Resumo da Produ√ß√£o', 'Total']],
                body: [
                    ['Tratamentos Focais', summary.tratamentoFocal],
                    ['Larvicida Utilizado', `${summary.gramas.toFixed(1)} g`],
                    ['Dep√≥sitos Tratados', summary.depositosTratados],
                    ['Dep√≥sitos Eliminados', summary.eliminados],
                ],
            });
            finalY = doc.lastAutoTable.finalY;
            
            // Tabela 3: Situa√ß√£o das Visitas
            doc.autoTable({
                ...tableOptions,
                startY: finalY + 10,
                head: [['Situa√ß√£o das Visitas', 'Total']],
                body: [
                    ['Im√≥veis Fechados', summary.fechado],
                    ['Recusas', summary.recusado],
                    [{ content: 'Total de Focos', styles: { fontStyle: 'bold', textColor: '#DC2626' } }, { content: summary.focos, styles: { fontStyle: 'bold', textColor: '#DC2626' } }]
                ],
            });
            finalY = doc.lastAutoTable.finalY;

            // Se√ß√£o de Pontos de Aten√ß√£o (Focos)
            const imovelMap = { 'R': 'Resid√™ncia', 'C': 'Com√©rcio', 'TB': 'Terreno Baldio', 'O': 'Outro' };
            if(summary.hotspots.length > 0) {
                finalY += 15;
                if (finalY > pageHeight - 20) { doc.addPage(); finalY = 30; }
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Pontos de Aten√ß√£o (Focos)', 15, finalY);
                finalY += 10;
                summary.hotspots.forEach(foco => {
                    if (finalY > pageHeight - 40) { doc.addPage(); finalY = 30; }
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'normal');
                    const focoText = `Bairro: ${foco.bairro}, Quart.: ${foco.quarteirao}, Rua: ${foco.logradouro}, ${foco.numero}, Tipo: ${imovelMap[foco.tipo] || foco.tipo}`;
                    const splitText = doc.splitTextToSize(focoText, 180);
                    doc.text(splitText, 18, finalY);
                    finalY += (splitText.length * 8) + 3; // Adjust spacing
                });
            }

            // Se√ß√£o de An√°lise da IA
            const aiText = document.getElementById('aiReportContent').innerText;
            if (aiText && aiText !== 'Carregando...') {
                finalY += 10;
                if (finalY > pageHeight - 30) { doc.addPage(); finalY = 30; }
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('An√°lise Inteligente do Per√≠odo', 15, finalY);
                finalY += 10;
                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                const splitText = doc.splitTextToSize(aiText, 180);
                splitText.forEach(line => {
                     if (finalY > pageHeight - 20) { doc.addPage(); finalY = 30; }
                     doc.text(line, 15, finalY);
                     finalY += 8;
                });
            }
            
            addHeaderFooter();
            doc.save(`relatorio_periodo_${agentName.split(' ')[0]}_${new Date().toISOString().slice(0,10)}.pdf`);
        });

        mainContent.addEventListener('input', (e) => {
            const target = e.target;
            
            if (target.matches('.form-input, .form-select')) {
                target.dataset.manualInput = 'true';
                if (target.value.trim() !== '') {
                    target.classList.add('is-filled');
                } else {
                    target.classList.remove('is-filled');
                }
            }
            
            // Save data first to ensure the latest changes are captured
            saveData(); 

            const card = target.closest('.visita-card');
            if (card) {
                updateCardStatus(card); // Now this will call saveCurrentDayToHistory with fresh data
            }
            updateAndRenderSummary();
        });
        
        mainContent.addEventListener('blur', (e) => {
            const target = e.target;
            if (target.matches('input[type="text"]') && target.value) {
                target.value = formatAndCorrectText(target.value);
            }
            
            // --- L√ìGICA DE REPLICA√á√ÉO INTELIGENTE APRIMORADA ---
            const replicationClasses = ['.bairro-imovel', '.logradouro', '.quarteirao', '.lado'];
            const targetIsReplicable = replicationClasses.some(c => target.matches(c)) || target.matches('#bairro');

            if (targetIsReplicable) {
                const valueToReplicate = target.value;
                let sourceIndex = -1;
                let fieldClass = '';

                if (target.matches('#bairro')) {
                    fieldClass = '.bairro-imovel';
                    sourceIndex = -1; // Come√ßa a replicar do primeiro card
                } else {
                    const sourceCard = target.closest('.visita-card');
                    sourceIndex = sourceCard ? parseInt(sourceCard.dataset.index, 10) : -1;
                    fieldClass = replicationClasses.find(c => target.matches(c));
                }
                
                if (fieldClass) {
                    const allCards = document.querySelectorAll('.visita-card');
                    allCards.forEach((card, index) => {
                        if (index > sourceIndex) {
                            const fieldToUpdate = card.querySelector(fieldClass);
                            if (fieldToUpdate) {
                                fieldToUpdate.value = valueToReplicate;
                                fieldToUpdate.dataset.manualInput = 'false';
                                if(valueToReplicate) fieldToUpdate.classList.add('is-filled');
                                else fieldToUpdate.classList.remove('is-filled');
                                updateCardStatus(card);
                            }
                        }
                    });
                }
            }

            const card = target.closest('.visita-card');
            if (card) {
                updateCardStatus(card);
            }

            if (target.id === 'agente') updateAutocomplete('agent', target.value);
            if (target.id === 'bairro' || target.classList.contains('bairro-imovel')) updateAutocomplete('bairro', target.value);
            if (target.classList.contains('logradouro')) updateAutocomplete('street', target.value);
            saveData();
        }, true);
        
        visitasContainer.addEventListener('focusin', (e) => {
            const card = e.target.closest('.visita-card');
            if(card) {
                const logradouro = card.querySelector('.logradouro').value || '...';
                const numero = card.querySelector('.numero').value || '...';
                fixedPropertyInfo.textContent = `Im√≥vel: ${logradouro}, ${numero}`;
            }
        });

        visitasContainer.addEventListener('click', (e) => {
            const header = e.target.closest('.card-header');
            if (header) {
                const content = header.nextElementSibling;
                const isExpanded = header.getAttribute('data-expanded') === 'true';
                header.setAttribute('data-expanded', !isExpanded);
                content.classList.toggle('show');
                saveData();
                return;
            }
            if (e.target.matches('.toggle-check')) {
                e.target.classList.toggle('is-checked');
                updateToggleHTML(e.target);
                updateAndRenderSummary();
                saveData();
            }
        });
        
        modalConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideModal(); });
        modalCancelBtn.addEventListener('click', hideModal);

        backupBtn.addEventListener('click', () => {
            const username = document.getElementById('username').value || 'agente';
            const dataToBackup = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('aceFlow')) {
                    dataToBackup[key] = localStorage.getItem(key);
                }
            }
            
            const blob = new Blob([JSON.stringify(dataToBackup, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ace_flow_backup_${username}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('Backup conclu√≠do com sucesso!');
        });

        restoreInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    showModal('Tem certeza que deseja restaurar este backup? Todos os dados atuais ser√£o substitu√≠dos.', () => {
                        Object.keys(data).forEach(key => {
                            localStorage.setItem(key, data[key]);
                        });
                        alert('Dados restaurados com sucesso! O aplicativo ser√° recarregado.');
                        location.reload();
                    });
                } catch (error) {
                    alert('Arquivo de backup inv√°lido ou corrompido.');
                    console.error("Erro ao restaurar:", error);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Limpa o input para permitir o mesmo arquivo novamente
        });

        // --- L√ìGICA DAS CURIOSIDADES ---
        curiositiesBtn.addEventListener('click', () => {
            subButtonsContainer.classList.toggle('hidden');
        });

        const createFaqModal = (modalEl, title, intro, qnaArray) => {
            let qnaHTML = '';
            qnaArray.forEach((item, index) => {
                qnaHTML += `
                    <div class="faq-item border-b border-gray-200">
                        <div class="faq-question flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                            <span class="font-semibold text-gray-800">${index + 1}. ${item.q}</span>
                            <span class="faq-toggle-icon text-2xl text-gray-400 transition-transform duration-300">+</span>
                        </div>
                        <div class="faq-answer text-gray-600 leading-relaxed">
                           ${item.a}
                        </div>
                    </div>
                `;
            });

            modalEl.innerHTML = `
                <div class="card p-0 w-11/12 max-w-4xl max-h-[90vh] flex flex-col">
                    <header class="sticky top-0 bg-white/80 backdrop-blur-sm z-10 flex justify-between items-center border-b p-4">
                        <h2 class="section-title">${title}</h2>
                        <button class="close-faq-modal text-3xl font-bold">&times;</button>
                    </header>
                    <div class="flex-grow overflow-y-auto p-6">
                        <p class="mb-6 text-text-muted">${intro}</p>
                        <h3 class="text-xl font-bold mb-4 text-center">Tire suas D√∫vidas: O Guia Definitivo sobre Dengue e Aedes aegypti</h3>
                        <div class="bg-white rounded-lg shadow-inner">
                           ${qnaHTML}
                        </div>
                    </div>
                </div>
            `;
            modalEl.classList.remove('hidden');
        };

        document.body.addEventListener('click', (e) => {
            if (e.target.matches('.close-faq-modal')) {
                e.target.closest('.modal').classList.add('hidden');
            }
            const question = e.target.closest('.faq-question');
            if (question) {
                const answer = question.nextElementSibling;
                question.classList.toggle('active');
                answer.classList.toggle('show');
            }
        });

        showDengueModalBtn.addEventListener('click', () => {
            const dengueQNA = [
                {q: "Quais s√£o os sintomas cl√°ssicos da dengue?", a: "Os sintomas mais comuns s√£o febre alta (acima de 38¬∞C) de in√≠cio s√∫bito, dor de cabe√ßa forte, dor atr√°s dos olhos, dores intensas no corpo e nas articula√ß√µes, al√©m de fraqueza e cansa√ßo. Manchas vermelhas na pele tamb√©m podem aparecer."},
                {q: "Como √© a principal forma de preven√ß√£o?", a: "A melhor e mais eficaz forma de preven√ß√£o √© a elimina√ß√£o dos criadouros do mosquito. Isso significa n√£o deixar √°gua parada em nenhum tipo de recipiente, como vasos de plantas, pneus velhos, garrafas, caixas d'√°gua destampadas e calhas sujas. A regra √© clara: n√£o deu √°gua para o mosquito, ele n√£o se cria."},
                {q: "Qual √© o tratamento para a dengue?", a: "N√£o existe um medicamento espec√≠fico para tratar o v√≠rus da dengue. O tratamento consiste em aliviar os sintomas. √â fundamental manter-se em repouso, beber muito l√≠quido (√°gua, sucos, soro de reidrata√ß√£o oral) para evitar a desidrata√ß√£o e usar apenas medicamentos indicados por um profissional de sa√∫de para febre e dor, como paracetamol ou dipirona."},
                {q: "Quais s√£o os sinais de alerta para a dengue grave?", a: "Ap√≥s o per√≠odo de febre, geralmente entre o 3¬∫ e o 7¬∫ dia, √© crucial ficar atento a sinais como dor abdominal intensa e cont√≠nua, v√¥mitos persistentes, sangramento de mucosas (nariz, gengiva), sonol√™ncia, irritabilidade, tontura ao se levantar e ac√∫mulo de l√≠quidos. A presen√ßa de um ou mais desses sintomas indica a necessidade de procurar atendimento m√©dico de urg√™ncia."},
                {q: "Posso tomar qualquer rem√©dio para dor e febre?", a: "N√£o! Em caso de suspeita de dengue, √© terminantemente proibido o uso de medicamentos √† base de √°cido acetilsalic√≠lico (AAS), como a Aspirina, e outros anti-inflamat√≥rios n√£o esteroides (como ibuprofeno e nimesulida). Esses medicamentos podem aumentar o risco de hemorragias e agravar a doen√ßa."},
                {q: "Posso pegar dengue mais de uma vez?", a: "Sim. Existem quatro sorotipos do v√≠rus (DENV-1, 2, 3 e 4). A infec√ß√£o por um deles gera imunidade permanente apenas para aquele sorotipo. Portanto, uma pessoa pode ter dengue at√© quatro vezes."},
                {q: "A dengue √© contagiosa?", a: "N√£o diretamente. Uma pessoa n√£o transmite a doen√ßa para outra. A dengue s√≥ √© transmitida pela picada da f√™mea do mosquito Aedes aegypti que tenha se infectado ao picar algu√©m com o v√≠rus."},
                {q: "Existe vacina contra a dengue?", a: "Sim. Existe vacina contra a dengue, que est√° sendo progressivamente implementada no sistema p√∫blico de sa√∫de para p√∫blicos espec√≠ficos e tamb√©m est√° dispon√≠vel na rede privada. Ela √© uma ferramenta importante, mas n√£o elimina a necessidade de combater o mosquito."},
                {q: "√â poss√≠vel estar com dengue e n√£o ter sintomas?", a: "Sim. Muitas infec√ß√µes s√£o assintom√°ticas. A pessoa n√£o sente nada, mas se um mosquito a picar nesse per√≠odo, ele se contamina e passa a transmitir o v√≠rus para outras pessoas."},
                {q: "A dengue pode deixar sequelas?", a: "Sim. Embora a maioria se recupere bem, algumas pessoas podem sentir cansa√ßo intenso, dores nas articula√ß√µes e fraqueza muscular por semanas ou at√© meses ap√≥s a infec√ß√£o, condi√ß√£o conhecida como fadiga p√≥s-dengue."},
                {q: "Por que a dengue √© mais comum no ver√£o?", a: "A combina√ß√£o de calor e chuvas frequentes cria o ambiente ideal para a prolifera√ß√£o do Aedes aegypti. As temperaturas mais altas aceleram o ciclo de vida do mosquito, fazendo com que mais mosquitos nas√ßam e piquem em menos tempo."},
                {q: "A doen√ßa √© mais perigosa em crian√ßas e idosos?", a: "Sim. Crian√ßas, idosos e pessoas com doen√ßas cr√¥nicas (como diabetes e hipertens√£o) t√™m maior risco de desenvolver as formas graves da doen√ßa e apresentar complica√ß√µes."},
                {q: "O v√≠rus da dengue pode ser transmitido pela amamenta√ß√£o?", a: "N√£o h√° evid√™ncias de que o v√≠rus da dengue seja transmitido atrav√©s do leite materno. A amamenta√ß√£o √© segura e deve ser mantida, pois os benef√≠cios superam os riscos."},
                {q: "Qual a diferen√ßa entre Dengue, Zika e Chikungunya?", a: "Embora transmitidas pelo mesmo mosquito e com sintomas iniciais parecidos (febre, dor de cabe√ßa), a principal caracter√≠stica da Chikungunya s√£o as dores articulares extremamente intensas, enquanto a Zika costuma ter um quadro mais leve, com manchas na pele e coceira mais proeminentes. Apenas um m√©dico pode fazer o diagn√≥stico correto."},
                {q: "O que significa o termo 'dengue hemorr√°gica'?", a: "Este termo caiu em desuso. A classifica√ß√£o atual divide a doen√ßa em 'Dengue' (com ou sem sinais de alarme) e 'Dengue Grave'. A forma grave √© caracterizada por extravasamento de plasma, sangramentos severos ou comprometimento grave de √≥rg√£os."}
            ];
            createFaqModal(dengueModal, 'ü¶ü Sobre a Dengue: O que Voc√™ Precisa Saber', "Entender a dengue √© o primeiro passo para se proteger e cuidar da sua fam√≠lia. A doen√ßa pode evoluir de um quadro leve para uma condi√ß√£o grave, exigindo aten√ß√£o redobrada.", dengueQNA);
        });

        showAedesModalBtn.addEventListener('click', () => {
             const aedesQNA = [
                {q: "Como identificar o Aedes aegypti?", a: "Ele √© um mosquito pequeno (menor que um pernilongo comum), de cor preta ou marrom-escura, com listras e manchas brancas distintas no corpo e, principalmente, nas pernas. Sua atividade √© maior durante o dia."},
                {q: "Onde o mosquito coloca seus ovos?", a: "A f√™mea deposita seus ovos nas paredes de recipientes com √°gua parada, bem pr√≥ximos √† superf√≠cie da √°gua. Ela prefere √°gua relativamente limpa, mas pode se adaptar. Qualquer objeto que acumule √°gua pode virar um criadouro."},
                {q: "Quanto tempo leva para o ovo virar um mosquito adulto?", a: "Em condi√ß√µes favor√°veis (calor e umidade), o ciclo completo, do ovo ao mosquito adulto, leva em m√©dia de 7 a 10 dias. Por isso a import√¢ncia da vistoria semanal dos quintais."},
                {q: "O 'fumac√™' acaba com o problema da dengue?", a: "N√£o. O 'fumac√™' (aplica√ß√£o de inseticida a ultrabaixo volume) mata apenas os mosquitos adultos que est√£o voando no momento da aplica√ß√£o. Ele n√£o tem efeito sobre os ovos e as larvas que est√£o na √°gua. A √∫nica solu√ß√£o definitiva √© eliminar os criadouros."},
                {q: "Qual a dist√¢ncia que o Aedes aegypti voa?", a: "Seu raio de voo √© curto, geralmente entre 50 a 100 metros do local onde nasceu. Isso significa que, na grande maioria das vezes, o mosquito que pica dentro de uma casa nasceu no pr√≥prio quintal ou na vizinhan√ßa imediata."},
                {q: "Por que s√≥ a f√™mea pica?", a: "Apenas a f√™mea se alimenta de sangue, pois ele cont√©m as prote√≠nas necess√°rias para o desenvolvimento e amadurecimento dos seus ovos. Os machos se alimentam exclusivamente de seiva de plantas."},
                {q: "Os ovos do mosquito s√£o resistentes?", a: "Extremamente. Os ovos podem sobreviver por mais de um ano em um local seco. Assim que entram em contato com a √°gua novamente, eles podem eclodir e dar in√≠cio a um novo ciclo."},
                {q: "O que atrai o mosquito at√© uma pessoa?", a: "O Aedes aegypti √© atra√≠do principalmente pelo g√°s carb√¥nico (CO‚ÇÇ) que liberamos na respira√ß√£o e por odores corporais, como o √°cido l√°tico liberado no suor. Ele tamb√©m √© atra√≠do pelo calor do corpo."},
                {q: "Roupas escuras realmente atraem mais o mosquito?", a: "Sim. O mosquito se orienta pela vis√£o e contraste. Cores escuras e vibrantes, como preto e vermelho, se destacam mais no ambiente e atraem sua aten√ß√£o, ao contr√°rio de cores claras, como branco e bege."},
                {q: "O Aedes aegypti pica por cima da roupa?", a: "Sim. Se o tecido da roupa for fino e justo ao corpo, como leggings e camisetas de algod√£o fino, o aparelho picador do mosquito pode atravess√°-lo e alcan√ßar a pele."},
                {q: "Velas de citronela e outras plantas resolvem?", a: "Plantas e velas de citronela ou andiroba t√™m um efeito repelente muito limitado, restrito a uma √°rea pequena e por pouco tempo. Elas n√£o s√£o eficazes para proteger um ambiente inteiro e n√£o substituem a necessidade de eliminar os criadouros."},
                {q: "O mosquito prefere picar em que parte do corpo?", a: "Ele tem o h√°bito de picar baixo, geralmente nas pernas, tornozelos e p√©s, pois voa a uma baixa altura."},
                {q: "Quantos ovos uma f√™mea pode colocar?", a: "Durante sua vida (que dura cerca de 30 a 45 dias), uma √∫nica f√™mea pode colocar mais de 200 ovos, distribuindo-os por v√°rios criadouros diferentes."},
                {q: "O Aedes aegypti tamb√©m vive dentro de casa?", a: "Sim, ele √© um mosquito dom√©stico e peridom√©stico. Ele se abriga dentro de casa, em locais escuros e frescos, como atr√°s de m√≥veis, cortinas e arm√°rios, para se proteger do calor intenso e descansar."},
                {q: "Al√©m da dengue, o que mais ele transmite?", a: "Este mesmo mosquito √© o vetor respons√°vel pela transmiss√£o do Zika V√≠rus, da Febre Chikungunya e da Febre Amarela urbana."}
            ];
            createFaqModal(aedesModal, 'ü¶ü Sobre o Vetor, Aedes aegypti: Conhe√ßa o Inimigo', "Este pequeno mosquito √© um grande problema de sa√∫de p√∫blica. Conhecer seus h√°bitos e ciclo de vida √© a chave para um combate eficiente.", aedesQNA);
        });

        // Event Listeners for "Minha √Årea"
        sectorModal.addEventListener('submit', (e) => {
            if (e.target.id === 'add-property-form') {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const sectorKey = `aceFlowSectorData_${username}`;
                
                const newBairro = document.getElementById('new-prop-bairro').value.trim();
                const newQuarteirao = document.getElementById('new-prop-quarteirao').value.trim();
                const newLogradouro = document.getElementById('new-prop-logradouro').value.trim();
                const newNumero = document.getElementById('new-prop-numero').value.trim();
                const newTipo = document.getElementById('new-prop-tipo').value;

                if (!newBairro || !newQuarteirao || !newLogradouro || !newNumero || !newTipo) {
                    alert('Por favor, preencha todos os campos para adicionar o im√≥vel.');
                    return;
                }

                const newProp = {
                    bairro: formatAndCorrectText(newBairro),
                    quarteirao: newQuarteirao,
                    logradouro: formatAndCorrectText(newLogradouro),
                    numero: newNumero,
                    tipo: newTipo
                };

                const propertyId = `${newProp.bairro}-${newProp.quarteirao}-${newProp.logradouro}-${newProp.numero}-${newProp.tipo}`.toLowerCase().replace(/\s+/g, '-');
                
                let sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };

                if (sectorData.properties[propertyId]) {
                    alert('Este im√≥vel j√° est√° cadastrado.');
                    return;
                }

                sectorData.properties[propertyId] = newProp;
                localStorage.setItem(sectorKey, JSON.stringify(sectorData));
                
                const tableBody = document.getElementById('sector-table-body');
                tableBody.insertAdjacentHTML('beforeend', generatePropertyRowHTML(newProp));
                e.target.reset();
                ['#new-prop-bairro', '#new-prop-quarteirao', '#new-prop-logradouro', '#new-prop-numero', '#new-prop-tipo'].forEach(sel => {
                    document.querySelector(sel).classList.remove('is-filled');
                });
            }
        });

        sectorModal.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-property-btn')) {
                const propertyId = e.target.dataset.id;
                const row = e.target.closest('tr');
                
                const username = document.getElementById('username').value;
                const sectorKey = `aceFlowSectorData_${username}`;
                let sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };
                
                const keyToDelete = Object.keys(sectorData.properties).find(key => 
                    `${sectorData.properties[key].bairro}-${sectorData.properties[key].quarteirao}-${sectorData.properties[key].logradouro}-${sectorData.properties[key].numero}-${sectorData.properties[key].tipo}`.toLowerCase().replace(/\s+/g, '-') === propertyId
                );

                if (keyToDelete) {
                    delete sectorData.properties[keyToDelete];
                    localStorage.setItem(sectorKey, JSON.stringify(sectorData));
                    row.remove();
                }
            } else if (e.target.closest('.sector-neighborhood-btn')) {
                const bairro = e.target.closest('.sector-neighborhood-btn').dataset.bairro;
                renderBlocks(bairro);
            } else if (e.target.closest('.sector-block-btn')) {
                const { bairro, block } = e.target.closest('.sector-block-btn').dataset;
                renderProperties(bairro, block);
            }
        });
        
        sectorBackBtn.addEventListener('click', () => {
            const lastView = sectorNavigationStack.pop();
            if (lastView) {
                if (lastView.view === 'neighborhoods') {
                    renderNeighborhoods();
                } else if (lastView.view === 'blocks') {
                    renderBlocks(lastView.bairro);
                }
            }
        });

        sectorModal.addEventListener('input', (e) => {
            if(e.target.matches('#add-property-form .form-input, #add-property-form .form-select')) {
                 if (e.target.value.trim() !== '') {
                    e.target.classList.add('is-filled');
                } else {
                    e.target.classList.remove('is-filled');
                }
            }
        });

        sectorModal.addEventListener('blur', (e) => {
            if(e.target.matches('#new-prop-bairro, #new-prop-logradouro')) {
                 if (e.target.value) {
                    e.target.value = formatAndCorrectText(e.target.value);
                }
            }
        }, true);


        const initApp = () => {
             // Anima√ß√£o da Landing Page
            const sections = document.querySelectorAll('.fade-in-section');
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    }
                });
            }, { threshold: 0.1 });
            sections.forEach(section => observer.observe(section));

            agentList = JSON.parse(localStorage.getItem('aceFlowagentList')) || [];
            bairroList = JSON.parse(localStorage.getItem('aceFlowbairroList')) || [];
            streetList = JSON.parse(localStorage.getItem('aceFlowstreetList')) || [];
            agentSuggestions.innerHTML = agentList.map(item => `<option value="${item}"></option>`).join('');
            bairroSuggestions.innerHTML = bairroList.map(item => `<option value="${item}"></option>`).join('');
            streetSuggestions.innerHTML = streetList.map(item => `<option value="${item}"></option>`).join('');
            populateSelects();

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dataInput.value = `${year}-${month}-${day}`;
            
            dataInput.classList.add('is-filled');
            loadGoalData();
        };
        
        initApp();
    });
    </script>
</body>
</html>
